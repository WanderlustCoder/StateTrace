# StateTrace Phase 1 Telemetry Dictionary

This document defines core telemetry events for product usage and ingestion performance. It also includes a short section on engineering/agent telemetry to help us see how agent contributions perform over time.

## Product & ingestion metrics

| Event/Metric | Description | Schema fields | Source | Aggregation | Target/Alert |
|--------------|-------------|---------------|--------|-------------|--------------|
| **ParseDuration** | Time to parse a single device log bundle | `Hostname` (string), `Site` (string), `StartTime` (datetime), `DurationSeconds` (float) | Parser pipeline | p95 & max per day | p95 ≤ 3 s; alert if max > 10 s |
| **RowsWritten** | Records inserted/updated for a host ingestion | `Hostname`, `Site`, `RunDate`, `Rows` (int), `DeletedRows` (int) | Persistence layer | Sum per site per day | Monitor for outliers |
| **SkippedDuplicate** | Hosts skipped due to unchanged hash | `Site`, `HostCount` (int), `Date` | Ingestion scheduler | Daily total | Expect high skip rate (>50%) after incremental updates |
| **DatabaseWriteLatency** | Time waiting for DB locks/commit | `Site`, `StartTime`, `LatencyMs` (int) | Persistence | Average & p95 | p95 ≤ 200 ms; alert if > 500 ms |
<!-- LANDMARK: ST-E-004 phase1 dictionary coverage refresh -->
| **InterfaceSiteCacheMetrics** | Site cache hydration + snapshot timing for interface cache | `Site` (string), `CacheStatus` (string), `Refreshed` (bool), `HydrationDurationMs` (int), `SnapshotDurationMs` (int), `RecordsetDurationMs` (int), `RecordsetProjectDurationMs` (int), `BuildDurationMs` (int), `HostMapDurationMs` (int), `HostMapSignatureMatchCount` (int), `HostMapSignatureRewriteCount` (int), `HostMapSignatureMismatchSamples` (string, optional), `HostMapEntryAllocationCount` (int), `HostMapEntryPoolReuseCount` (int), `HostMapLookupCount` (int), `HostMapLookupMissCount` (int), `PreviousHostCount` (int, optional), `PreviousPortCount` (int, optional), `PreviousSnapshotStatus` (string, optional) | Interface cache hydration | p50/p95 per site; compare warm vs cold | Plan B gates: docs/telemetry/Automation_Gates.md, docs/plans/PlanB_Performance.md |
| **InterfaceSyncTiming** | Per-host interface sync duration + persistence timing (includes site cache fetch) | `Site` (string), `Hostname` (string), `DurationMs` (int), `SiteCacheFetchDurationMs` (int), `SiteCacheFetchStatus` (string), `SiteCacheProvider` (string), `SiteCacheRefreshDurationMs` (int), `SiteCacheSnapshotDurationMs` (int), `SiteCacheRecordsetDurationMs` (int), `SiteCacheBuildDurationMs` (int), `SiteCacheHostMapDurationMs` (int), `RowsStaged` (int), `BulkAttempted` (bool), `BulkSucceeded` (bool), `StreamDispatchDurationMs` (int, optional), `SiteCacheUpdateDurationMs` (int) | Parser persistence | p95 by site + host; event count vs processed hosts | Plan A/Plan D completeness: docs/telemetry/Automation_Gates.md, docs/plans/PlanA_RoutingReliability.md, docs/plans/PlanD_FeatureExpansion.md |
| **InterfacePortQueueMetrics** | Interface port queue build timing for dispatcher sweep (queue delay) | `Hostname` (string), `BatchId` (string), `QueueBuildDurationMs` (int), `QueueBuildDelayMs` (int), `BatchCount` (int), `TotalPorts` (int), `ChunkSize` (int), `ChunkSource` (string) | Interface dispatch harness | Average + p95/p99 for `QueueBuildDelayMs` | Plan A queue delay gate: docs/telemetry/Automation_Gates.md, docs/plans/PlanA_RoutingReliability.md |
| **PortBatchReady** | Per-host batch readiness for incremental interface loading | `Hostname` (string), `BatchId` (string), `RunDate` (string), `PortsCommitted` (int), `ChunkSize` (int), `EstimatedBatchCount` (int), `Timestamp` (datetime), `Synthesized` (bool, optional), `SourceEvent` (string, optional) | Parser persistence + synthesis helper | Per-site counts + streaks | Plan D incremental gates: docs/telemetry/Automation_Gates.md, docs/plans/PlanD_FeatureExpansion.md |
| **ParserSchedulerLaunch** | Scheduler launch telemetry for site rotation fairness | `Site` (string), `ActiveWorkers` (int), `ActiveSites` (int), `ThreadBudget` (int), `QueuedJobs` (int), `QueuedSites` (int) | Parser scheduler | Max streak + launch counts per run | Plan A/Plan D scheduler fairness: docs/telemetry/Automation_Gates.md, docs/plans/PlanA_RoutingReliability.md, docs/plans/PlanD_FeatureExpansion.md |
| **WarmRunComparison** | Warm vs cold interface call timing summary | `SummaryType` (string), `ColdHostCount` (int), `WarmHostCount` (int), `ColdInterfaceCallAvgMs` (float), `WarmInterfaceCallAvgMs` (float), `ImprovementAverageMs` (float), `ImprovementPercent` (float), `WarmCacheProviderHitCount` (int), `WarmCacheProviderMissCount` (int), `WarmCacheHitRatioPercent` (float), `WarmProviderCounts` (object), `ColdProviderCounts` (object) | Warm-run harness | Per-run summary | Plan B warm-run gate: docs/telemetry/Automation_Gates.md, docs/plans/PlanB_Performance.md |
| **DiffUsageRate** | Compare view diff execution usage (one event per executed compare) | `Timestamp` (datetime), `Source` (string), `Status` (string), `UsageNumerator` (int), `UsageDenominator` (int), `Site` (string), `Hostname` (string), `Hostname2` (string), `Port1` (string), `Port2` (string), `Vrf` (string, optional) | Compare view UI | Rolling weekly ratio (sum `UsageNumerator` / sum `UsageDenominator`) | >= 70% in pilot |
| **DiffCompareDurationMs** | Compare view diff execution duration (per executed compare) | `TimestampUtc` (datetime), `Source` (string), `Status` (string), `DurationMs` (int), `Site` (string), `Hostname` (string), `Hostname2` (string), `Port1` (string), `Port2` (string), `Vrf` (string, optional) | Compare view UI | p50/p95 of `DurationMs` for `Status=Executed`, segmented by site | Establish baseline; alert if p95 regresses 2x |
| **DiffCompareResultCounts** | Compare view diff result cardinality (line-level; Added/Removed from Compare-Object, ChangedCount fixed at 0, UnchangedCount for shared trimmed lines; TotalCount is sum) | `TimestampUtc` (datetime), `Source` (string), `Status` (string), `TotalCount` (int), `AddedCount` (int), `RemovedCount` (int), `ChangedCount` (int), `UnchangedCount` (int), `Site` (string), `Hostname` (string), `Hostname2` (string), `Port1` (string), `Port2` (string), `Vrf` (string, optional), `DurationMs` (int, optional on failed compares) | Compare view UI | Sum counts per site/run, filter `Status=Executed` | Establish baseline per site; alert on spike in Added/Removed totals |
| **DriftDetectionTime** | Time between change and detection | `Hostname`, `ChangeDetectedAt`, `ChangedField`, `DurationMinutes` | Diff/anomaly engine | p95 per change type | −40% vs. baseline |
| **UserAction (CoreFlow)** | Core UI action telemetry (ScanLogs, LoadFromDb, HelpQuickstart, InterfacesView, CompareView) | `Action` (string), `Site` (string, optional), `Hostname` (string, optional), `Context` (string, optional), `Timestamp` (datetime), `Hostname2` (string, optional), `Port1` (string, optional), `Port2` (string, optional) | MainWindow/UI modules | Daily count + action coverage | Plan H adoption gate: docs/telemetry/Automation_Gates.md, docs/plans/PlanH_UserExperience.md |
<!-- LANDMARK: ST-D-004 span telemetry metrics -->
| **UserAction (SpanInfo)** | Span view fetch action (row counts per host) | `Action` (string, `SpanInfo`), `Hostname` (string), `Site` (string), `RowsBound` (int), `Timestamp` (datetime) | Span view UI | Daily count + row-count distribution | Alert on repeated zero-row fetches |
| **UserAction (SpanSnapshot)** | Span view snapshot action (row counts per host) | `Action` (string, `SpanSnapshot`), `Hostname` (string), `Site` (string), `RowsBound` (int), `Timestamp` (datetime) | Span view UI | Daily count + row-count distribution | Alert on repeated zero-row snapshots |
<!-- LANDMARK: ST-D-007 span usage telemetry metrics -->
| **UserAction (SpanViewUsage)** | Span view usage event (VLAN coverage per host) | `Action` (string, `SpanViewUsage`), `Hostname` (string), `VlanCount` (int), `RowsBound` (int), `Timestamp` (datetime) | Span view UI | Daily count + VLAN-count distribution | Alert on zero VLAN counts |

## Engineering / agent metrics (optional)

| Event/Metric | Description | Schema fields | Source | Aggregation | Target |
|--------------|-------------|---------------|--------|-------------|--------|
| **AgentTestPassRate** | Fraction of agent sessions with passing tests | `SessionId`, `Date`, `Passed` (bool) | CI/logs | Weekly ratio | ≥ 95% |
| **AgentChangeSize** | Lines changed per session | `SessionId`, `Files`, `Added`, `Removed` | VCS logs | Weekly p50/p95 | Keep p95 small |
| **AgentRevertRate** | Sessions that required rollback | `SessionId`, `Reason` | VCS/PRs | Weekly count | Near zero |

**Implementation notes:** Emit telemetry locally to `Logs/IngestionMetrics/<date>.json`. Engineering metrics can be derived from CI logs and PR metadata; do not include personal data. Use `Tools/Rollup-IngestionMetrics.ps1` to generate daily CSV summaries (totals, averages, and p95 values) for `ParseDuration`, `DatabaseWriteLatency`, `RowsWritten`, and `SkippedDuplicate`; append `-IncludePerSite` for per-site breakdowns and `-IncludeSiteCache` to surface `SiteCacheFetchDurationMs` status/provider counts and percentile timing.
