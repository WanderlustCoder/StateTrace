# Plan B - Performance & Ingestion Scale

## Objective
Reduce cold- and warm-run latency for parser, persistence, and shared-cache flows while keeping telemetry exhaustive enough for autonomous troubleshooting. Plan B owns autoscale heuristics, site-cache hydration, warm-run verification, and concurrency overrides.

## Current status (2025-11)
- Instrumentation now captures `InterfaceSiteCacheMetrics`, `InterfaceSiteCacheHostPersisted`, `SiteCacheRecordsetDurationMs`, and the new diff markers (`DiffComparisonDurationMs`, `LoadExistingRowSetCount`) captured during the warm-run optimization effort (`docs/notes/2025-11-07_warm-run-optimization-plan.md`). These fields surface directly in `Logs/IngestionMetrics/*.json`, feed `Tools\Analyze-WarmRunDiffHotspots.ps1`, and must appear in Plan E rollups.
- Shared cache normalization (`Normalize-InterfaceSiteCacheEntry`) plus the recently added keyed existing-row cache prototype keep preserved sessions typed, but the latest diagnostics (`Tools\Analyze-SharedCacheStoreState.ps1`, `Tools\Analyze-SiteCacheProviderReasons.ps1`) still report `SnapshotImported=0` and large `AccessRefresh` counts (`Logs/IngestionMetrics/2025-11-12.json`). Plan B must prove the importer fix + keyed cache reduce WLLS cold hydrations (now 0.65 s → 2.7 s) and share the evidence with Plans E/G before release gates pass.
- Warm regression harness (`Tools\Invoke-WarmRunRegression.ps1` via `Tools\Invoke-StateTracePipeline.ps1 -RunWarmRunRegression` or `Tools\Invoke-StateTraceVerification.ps1`) enforces ≥60% warm improvement and ≥99% cache hits, but the most recent preserved-session run (2025-11-09 summary inside the warm-run optimization note) showed cold 850 ms vs warm 851 ms with `WarmCacheHitRatioPercentRaw=0` because `SkipSiteCacheUpdate` stopped DatabaseWriteBreakdown from logging cache hits. Verification continues to fail while `AssertWarmCache` reports misses.
- Autoscale experiments (ceiling overrides) temporarily reduced `DatabaseWriteLatency` to ~387 ms averages, but we still need to document when overrides are safe, reset them automatically, and connect telemetry deltas back to `docs/CODEX_RUNBOOK.md` and the task board.
- Plan G release evidence and Plan E telemetry bundles both depend on Plan B exporting the cold/warm telemetry, shared-cache analyzers, and diff hotspot summaries for every candidate build (run `Tools\Publish-TelemetryBundle.ps1` to auto-discover the latest artifacts and call the bundler after each run).
- Risk register and release-readiness updates must mention any outstanding performance degradations; Plan B owns providing the artifacts/notes when perf gates block Plan G.

## Active work
| ID | Title | Owner | Status | Notes |
|----|-------|-------|--------|-------|
| ST-B-001 | Investigate WLLS snapshot/materialize regression | Ingestion | In Progress | Re-run the cold pipeline with `-RunSharedCacheDiagnostics`, confirm `SnapshotImported>0`, and capture analyzer output for both BOYO and WLLS before re-enabling warm regression. |
| ST-B-002 | Trial reduced auto-scale ceilings post-batching | Ingestion | Ready for Review | Evaluate whether ceilings=1 remains acceptable now that batching landed; record `ParseDuration`, `DatabaseWriteLatency`, and concurrency profile results. |
| ST-B-003 | Codify concurrency overrides | Automation | Ready | Document the override→metric mapping in `docs/CODEX_RUNBOOK.md` and enforce automatic reset/telemetry logging inside the harness scripts. |
| ST-B-004 | Restore preserved warm-run cache hits | Ingestion | In Progress | Use the shared-cache analyzers to drive the WLLS/BOYO investigations; keep logging provider/miss counts from `Logs/IngestionMetrics/2025-11-12.json` and `Logs/warmrun-regression-output.txt` until `WarmCacheHitRatioPercentRaw > 0`. |
| ST-B-005 | Validate keyed existing-row cache prototype | Parser / Ingestion | Ready | Follow the workflow in `docs/notes/2025-11-07_warm-run-optimization-plan.md`: cold pipeline with diagnostics → preserved-session harness (`Tools\Invoke-WarmRunTelemetry.ps1`) → confirm `SiteCacheProvider=Cache` for ≥70% hosts and capture the before/after telemetry in this plan + TaskBoard entry. |
| ST-B-006 | Automate warm-run diff hotspot triage | Automation | In Progress | `Tools\Invoke-StateTraceVerification.ps1` **and** `Tools\Invoke-WarmRunTelemetry.ps1` now support `-GenerateDiffHotspotReport [-DiffHotspotTop <n>] [-DiffHotspotOutputPath <file>]`, calling `Tools\Analyze-WarmRunDiffHotspots.ps1` automatically whenever warm-run telemetry is produced. Diff hotspot CSVs now land beside the telemetry (`Logs/IngestionMetrics/DiffHotspots-<timestamp>.csv`) and should be referenced in plan/task updates; wire the flag into warm-regression CI next. |
| ST-B-007 | Enforce shared-cache analyzers in verification | Automation | In Progress | `Tools\Invoke-StateTraceVerification.ps1` now accepts `-GenerateSharedCacheDiagnostics [-SharedCacheDiagnosticsDirectory <dir>]`, automatically running `Tools\Analyze-SharedCacheStoreState.ps1` and `Tools\Analyze-SiteCacheProviderReasons.ps1` against the latest ingestion metrics and exporting JSON summaries (`SharedCacheStoreState-<timestamp>.json`, `SiteCacheProviderReasons-<timestamp>.json`). Wire this flag into verification CI and fail builds when diagnostics reveal `SnapshotImported=0` or chronic `AccessRefresh`. |
| ST-B-008 | Publish warm-run telemetry bundles | Ingestion + PMO | Backlog | After each cold+warm run, run `Tools\Publish-TelemetryBundle.ps1` so the latest `Logs/IngestionMetrics/<date>.json`, `WarmRunTelemetry-*.json`, analyzer output, and diff hotspot CSV land in `Logs/TelemetryBundles/<date>/` (feeds Plan E ST-E-007 + Plan G release evidence). |
| ST-B-009 | Toggle skip-site-cache policy safely | Ingestion | Backlog | Document how/when `SkipSiteCacheUpdate` gets disabled (e.g., during cold pass only), add guardrails in the harness to reset it, and record the policy in this plan + `docs/CODEX_RUNBOOK.md`. |
| ST-B-010 | Risk register/update loop | PMO + Performance | Backlog | Whenever Plan B metrics slip past gates, add the scenario to `docs/RiskRegister.md` (with mitigation/owner) and reference the telemetry bundle + task board row so Plan G can trace the risk during release planning. |

## Recently delivered
- Restored `InterfaceSyncTiming` telemetry and dispatcher queue instrumentation (2025-10-15 historical log).
- Added warm-run verification thresholds to `VerificationModule` and `Tools\Invoke-StateTraceVerification.ps1` (2025-11-06).
- Authored shared-cache analyzer scripts (`Tools\Analyze-SharedCacheStoreState.ps1`, `Tools\Analyze-SiteCacheProviderReasons.ps1`) and documented the workflow in `docs/CODEX_SHARED_CACHE_DIAGNOSTICS.md`.

## Recent timeline (migrated from consolidated log)
| Date (MT) | Summary | Metrics / Artifacts | Source |
|-----------|---------|---------------------|--------|
| 2025-11-12 19:05 | Created `Tools/Analyze-SharedCacheStoreState.ps1` to summarize `InterfaceSiteCacheSharedStore*` telemetry (SnapshotImported counts, GetMiss/GetHit ratios, top sites). | `Tools/Analyze-SharedCacheStoreState.ps1`, sample output referencing `Logs/IngestionMetrics/2025-11-12.json`. | This document |
| 2025-11-12 19:20 | Ran the provider-reason analyzer against `Logs/IngestionMetrics/2025-11-12.json`: WLLS logged 192 `AccessRefresh` vs 74 `AccessCacheHit` events and BOYO logged 77 refreshes vs zero hits, highlighting missing snapshot imports. | Command: `pwsh Tools\Analyze-SiteCacheProviderReasons.ps1 -Path Logs\IngestionMetrics\2025-11-12.json -IncludeHostBreakdown -TopHosts 10`. | This document |
| 2025-11-12 19:35 | Shared-store telemetry showed `SnapshotImported=0`, `InitNewStore=25`, `GetMiss=1,897` vs `GetHit=1,842` (WLLS = 3,013 ops / 1,148 misses, BOYO = 1,075 ops / 272 misses), confirming every runspace rebuilt the store. | `Tools\Analyze-SharedCacheStoreState.ps1 -Path Logs\IngestionMetrics\2025-11-12.json -IncludeSiteBreakdown`. | This document |
| 2025-11-09 08:12 | Preserved warm run (`Tools\Invoke-WarmRunTelemetry.ps1 ... -OutputPath Logs\IngestionMetrics\WarmRunTelemetry-20251108-run3.json`) showed cold avg 850.19 ms vs warm 851.64 ms (-0.17% improvement) and `WarmCacheHitRatioPercentRaw=0`, prompting the keyed existing-row cache prototype. | Warm-run telemetry JSON + summary in `docs/notes/2025-11-07_warm-run-optimization-plan.md`. | docs/notes/2025-11-07_warm-run-optimization-plan.md |
| 2025-11-13 | Telemetry bundle requirement captured in Plans E/G; Plan B must deposit cold/warm telemetry + analyzer output for every release candidate via `Tools\Publish-TelemetryBundle.ps1`. | `Logs/TelemetryBundles/<date>/` README referencing Plan B ST-B-008/ST-B-010, Plan E ST-E-007, Plan G ST-G-007. | docs/plans/PlanE_Telemetry.md, docs/plans/PlanG_ReleaseGovernance.md |
| 2025-11-13 13:20 | Added `-GenerateDiffHotspotReport [-DiffHotspotTop] [-DiffHotspotOutputPath]` to both `Tools\Invoke-StateTraceVerification.ps1` and `Tools\Invoke-WarmRunTelemetry.ps1`, automatically invoking `Tools\Analyze-WarmRunDiffHotspots.ps1` and exporting CSVs next to warm-run telemetry (e.g., `Logs/IngestionMetrics/DiffHotspots-20251113-132000.csv`). | Verification harness + warm-run telemetry script updates (`Tools\Invoke-AllChecks.ps1 -TelemetryBundlePath Logs/TelemetryBundles/Release-20251113 -RequireTelemetryBundleReady`). | docs/agents/sessions/2025-11-13_session-0011.md |
| 2025-11-13 13:45 | Added `-GenerateSharedCacheDiagnostics [-SharedCacheDiagnosticsDirectory <dir>]` to `Tools\Invoke-StateTraceVerification.ps1`, automatically running the shared-cache analyzers and storing JSON summaries under `Logs/SharedCacheDiagnostics/` (or the supplied directory). | `SharedCacheStoreState-*.json`, `SiteCacheProviderReasons-*.json` generated during verification; see `Tools\Invoke-AllChecks.ps1 -TelemetryBundlePath Logs/TelemetryBundles/Release-20251113 -RequireTelemetryBundleReady`. | docs/agents/sessions/2025-11-13_session-0012.md |

## Automation hooks
- `Tools\Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -ResetExtractedLogs [-RunSharedCacheDiagnostics]` for cold runs (set `STATETRACE_SHARED_CACHE_SNAPSHOT` when seeding preserved stores).
- `Tools\Invoke-WarmRunRegression.ps1 -VerboseParsing` or `Tools\Invoke-StateTracePipeline.ps1 -RunWarmRunRegression` to capture cold/warm deltas; archive `WarmRunTelemetry-*.json`.
- `Tools\Invoke-StateTraceVerification.ps1 -SharedCacheMinimumSiteCount 2 -SharedCacheRequiredSites BOYO,WLLS -EmitWarmRunTelemetry` (and `Tools\Invoke-StateTraceScheduledVerification.ps1`) to combine pipeline, warm pass, analyzers, and assertions.
- Shared cache diagnostics: `Tools\Invoke-SharedCacheWarmup.ps1`, `Tools\Analyze-SharedCacheStoreState.ps1 -IncludeSiteBreakdown`, `Tools\Analyze-SiteCacheProviderReasons.ps1 -IncludeHostBreakdown` per `docs/CODEX_SHARED_CACHE_DIAGNOSTICS.md`.
- Diff hotspot review: `Tools\Analyze-WarmRunDiffHotspots.ps1 -TelemetryPath Logs\IngestionMetrics\WarmRunTelemetry-<run>.json -Top 20 [-OutputPath Logs\IngestionMetrics\WarmRunDiffHotspots.csv]`.
- Autoscale / overrides: `Import-Module .\Modules\ParserRunspaceModule.psm1; Get-AutoScaleConcurrencyProfile -DeviceFiles <paths>` plus `-ThreadCeilingOverride`, `-MaxWorkersPerSiteOverride`, `-MaxActiveSitesOverride`, `-MaxConsecutiveSiteLaunchesOverride`, `-JobsPerThreadOverride`, `-MinRunspacesOverride`, etc., all recorded in the plan/task board and reset after each run.
- Keyed existing-row cache validation: `Tools\Invoke-WarmRunTelemetry.ps1 -ResetExtractedLogs -ColdHistorySeed Empty -WarmHistorySeed ColdOutput -RefreshSiteCaches -AssertWarmCache:$false -OutputPath <file>` and follow-up analyzers (per warm-run optimization note).
- Evidence bundling: run `Tools\Publish-TelemetryBundle.ps1 -BundleName Release-<date> -PlanReferences PlanB,PlanE,PlanG -TaskBoardIds ST-B-008,ST-E-007,ST-G-007 -Notes "Cold+Warm telemetry + analyzers"` to auto-discover the latest logs and copy them (via `Tools\New-TelemetryBundle.ps1`) into `Logs/TelemetryBundles/<name>/` (include README noting commands + task IDs).

## Telemetry gates
- `DatabaseWriteLatency` p95 < 950 ms (cold) and < 500 ms (warm); alert if warm p95 > 600 ms.
- `InterfaceSiteCacheMetrics.SiteCacheFetchDurationMs` p95 < 5 s (log host-level values > 10 s) and `SnapshotImported > 0` for all parser runspaces.
- `WarmRunComparison.ImprovementPercent ≥ 60` with `WarmProviderCounts.Cache` covering every processed host; `WarmCacheHitRatioPercentRaw` must rise above 0 as keyed cache validation completes.
- `ParseDuration` p95 ≤ 3 s (max ≤ 10 s) and `RowsWritten` within ±1% of Access counts after performance-affecting changes (shared with Plan E but enforced here when tuning ingestion).
- Shared-cache analyzer outputs attached to the plan/task board whenever the cold pass or verification harness runs; failures block release until resolved.
- `InterfaceSiteCacheHostPersisted` counts match the expected host totals per site before signing off on shared snapshot health (log the counts in plan/task updates).

## References & history
- `docs/StateTrace_Consolidated_Plans.md` (Plan B entries) for the historical narrative.
- `docs/CODEX_SHARED_CACHE_DIAGNOSTICS.md` for analyzer workflow.
- `docs/notes/2025-11-07_warm-run-optimization-plan.md` for keyed cache context and telemetry baselines.
- `docs/CODEX_PLAN_AUTOMATION_MATRIX.md` and `docs/CODEX_RUNBOOK.md` for command matrices and override guidance.
- Warm-run telemetry exports: `Logs/IngestionMetrics/WarmRunTelemetry-*.json`; shared cache snapshots and diagnostics under `Logs/SharedCacheSnapshot/` and `Logs/IngestionMetrics/*.json`.

