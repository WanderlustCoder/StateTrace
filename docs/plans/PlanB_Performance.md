# Plan B - Performance & Ingestion Scale

## Objective
Reduce cold- and warm-run latency for parser, persistence, and shared-cache flows while keeping telemetry exhaustive enough for autonomous troubleshooting. Plan B owns autoscale heuristics, site-cache hydration, warm-run verification, and concurrency overrides.

## Current status (2025-11)
- Instrumentation now captures `InterfaceSiteCacheMetrics`, `InterfaceSiteCacheHostPersisted`, `SiteCacheRecordsetDurationMs`, and the new diff markers (`DiffComparisonDurationMs`, `LoadExistingRowSetCount`) captured during the warm-run optimization effort (`docs/notes/2025-11-07_warm-run-optimization-plan.md`). These fields surface directly in `Logs/IngestionMetrics/*.json`, feed `Tools\Analyze-WarmRunDiffHotspots.ps1`, and must appear in Plan E rollups.
- Shared cache normalization (`Normalize-InterfaceSiteCacheEntry`) plus the recently added keyed existing-row cache prototype keep preserved sessions typed, but the latest diagnostics (`Tools\Analyze-SharedCacheStoreState.ps1`, `Tools\Analyze-SiteCacheProviderReasons.ps1`) still report `SnapshotImported=0` and large `AccessRefresh` counts (`Logs/IngestionMetrics/2025-11-12.json`). Plan B must prove the importer fix + keyed cache reduce WLLS cold hydrations (now 0.65 s → 2.7 s) and share the evidence with Plans E/G before release gates pass.
- Warm regression harness (`Tools\Invoke-WarmRunRegression.ps1` via `Tools\Invoke-StateTracePipeline.ps1 -RunWarmRunRegression` or `Tools\Invoke-StateTraceVerification.ps1`) enforces ≥60% warm improvement and ≥99% cache hits, but the most recent preserved-session run (2025-11-09 summary inside the warm-run optimization note) showed cold 850 ms vs warm 851 ms with `WarmCacheHitRatioPercentRaw=0` because `SkipSiteCacheUpdate` stopped DatabaseWriteBreakdown from logging cache hits. Verification continues to fail while `AssertWarmCache` reports misses.
- Autoscale experiments (ceiling overrides) temporarily reduced `DatabaseWriteLatency` to ~387 ms averages, but we still need to document when overrides are safe, reset them automatically, and connect telemetry deltas back to `docs/CODEX_RUNBOOK.md` and the task board.
- Plan G release evidence and Plan E telemetry bundles both depend on Plan B exporting the cold/warm telemetry, shared-cache analyzers, and diff hotspot summaries for every candidate build (run `Tools\Publish-TelemetryBundle.ps1` to auto-discover the latest artifacts and call the bundler after each run).
- Risk register and release-readiness updates must mention any outstanding performance degradations; Plan B owns providing the artifacts/notes when perf gates block Plan G.
- 2025-12-17: Reduced parser overhead by batching telemetry writes in `TelemetryModule\Write-StTelemetryEvent` (flushes on `ParseDuration`/`SkippedDuplicate`, size/time thresholds; buffering disabled under Pester) and eliminating a redundant shared-cache lookup in `ParserPersistenceModule\Update-InterfacesInDb`. Quick pipeline runs on the BOYO/WLLS mock logs improved from ~34s wall time to ~7s, with `ParseDuration` now ~2.4s/0.35s and `DatabaseWriteLatency` ~290ms/99ms (`Logs/IngestionMetrics/2025-12-17.json`).
- 2025-12-18: Reduced parser persistence overhead by caching Access index/schema ensures per database, adding bulk seed timing telemetry (`BulkSeedEnsureDurationMs`, `BulkSeedRecordsetOpenDurationMs`, `IndexEnsureDurationMs`), and avoiding deep-clone shared-cache updates by publishing per-host fragments + shallow host-map merges. Validation: `Invoke-Pester Modules/Tests` passes; quick pipeline on BOYO/WLLS mock logs with `-DisableSharedCacheSnapshot -DatabasePath Data/PerfPipeline-{id}.accdb` reports `DatabaseWriteLatencyMs` ~229 ms, `InterfaceCallDurationMs` ~208 ms, `SiteCacheUpdateDurationMs` ~52 ms (`Logs/IngestionMetrics/2025-12-17.json`).
- 2025-12-18: Reduced per-host parsing overhead by caching compiled regexes used for command-block extraction and table parsing (DeviceLogParserModule + DeviceParsingCommon), adding a prompt fast-path to avoid regex work on non-prompt lines, precompiling Brocade auth-block matching, and avoiding unconditional `GC.Collect()` for small logs. Validation: `Invoke-Pester Modules/Tests` passes; `Tools\Invoke-StateTracePipeline.ps1 -Profile Quick -VerboseParsing` shows `ParseDuration` 2.48s/0.379s and `DatabaseWriteLatency` 275ms/101ms on BOYO/WLLS mock logs (`Logs/IngestionMetrics/2025-12-18.json`).

## Active work
| ID | Title | Owner | Status | Notes |
|----|-------|-------|--------|-------|
| ST-B-001 | Investigate WLLS snapshot/materialize regression | Ingestion | In Progress | 2025-11-28 pipeline + incremental checklist refreshed telemetry: `SnapshotImported=3`, `InitNewStore=15`, `InitReuseStore=6`, `GetMiss=50`, `GetHit=24`; WLLS `AccessCacheHit=5` / `AccessRefresh=0`, BOYO still `Unknown` (0 provider hits). Queue delay summary still missing (0 samples), and PortBatchReady remains synthetic/minimal (1 sw1 batch). Next: rerun with richer host coverage to emit real PortBatchReady + BOYO provider counts, capture queue delay summary, then rerun diagnostics and warm regression. 2025-12-17: Batching telemetry writes and removing a redundant shared-cache lookup eliminated multi-second warm-path overhead; see `docs/agents/sessions/2025-12-17_session-0001.md`. |
| ST-B-002 | Trial reduced auto-scale ceilings post-batching | Ingestion | Ready for Review | Evaluate whether ceilings=1 remains acceptable now that batching landed; record `ParseDuration`, `DatabaseWriteLatency`, and concurrency profile results. |
| ST-B-003 | Codify concurrency overrides | Automation | Ready | Document the override→metric mapping in `docs/CODEX_RUNBOOK.md` and enforce automatic reset/telemetry logging inside the harness scripts. |
| ST-B-004 | Restore preserved warm-run cache hits | Ingestion | In Progress | Use the shared-cache analyzers to drive the WLLS/BOYO investigations; keep logging provider/miss counts from `Logs/IngestionMetrics/2025-11-12.json` and `Logs/warmrun-regression-output.txt` until `WarmCacheHitRatioPercentRaw > 0`. |
| ST-B-005 | Validate keyed existing-row cache prototype | Parser / Ingestion | Ready | Follow the workflow in `docs/notes/2025-11-07_warm-run-optimization-plan.md`: cold pipeline with diagnostics → preserved-session harness (`Tools\Invoke-WarmRunTelemetry.ps1`) → confirm `SiteCacheProvider=Cache` for ≥70% hosts and capture the before/after telemetry in this plan + TaskBoard entry. |
| ST-B-006 | Automate warm-run diff hotspot triage | Automation | In Progress | `Tools\Invoke-StateTraceVerification.ps1` **and** `Tools\Invoke-WarmRunTelemetry.ps1` now support `-GenerateDiffHotspotReport [-DiffHotspotTop <n>] [-DiffHotspotOutputPath <file>]`, calling `Tools\Analyze-WarmRunDiffHotspots.ps1` automatically whenever warm-run telemetry is produced. Diff hotspot CSVs now land beside the telemetry (`Logs/IngestionMetrics/DiffHotspots-<timestamp>.csv`) and should be referenced in plan/task updates; wire the flag into warm-regression CI next. |
| ST-B-007 | Enforce shared-cache analyzers in verification | Automation | In Progress | `Tools\Invoke-StateTraceVerification.ps1` now accepts `-GenerateSharedCacheDiagnostics [-SharedCacheDiagnosticsDirectory <dir>]`, automatically running `Tools\Analyze-SharedCacheStoreState.ps1` and `Tools\Analyze-SiteCacheProviderReasons.ps1` against the latest ingestion metrics and exporting JSON summaries (`SharedCacheStoreState-<timestamp>.json`, `SiteCacheProviderReasons-<timestamp>.json`). Wire this flag into verification CI and fail builds when diagnostics reveal `SnapshotImported=0` or chronic `AccessRefresh`. |
| ST-B-008 | Publish warm-run telemetry bundles | Ingestion + PMO | Backlog | After each cold+warm run, run `Tools\Publish-TelemetryBundle.ps1` so the latest `Logs/IngestionMetrics/<date>.json`, `WarmRunTelemetry-*.json`, analyzer output, and diff hotspot CSV land in `Logs/TelemetryBundles/<date>/` (feeds Plan E ST-E-007 + Plan G release evidence). |
| ST-B-009 | Toggle skip-site-cache policy safely | Ingestion | In Progress | Guard module (`Tools/SkipSiteCacheUpdateGuard.psm1`) now backs `Tools\Invoke-StateTracePipeline.ps1` (`-DisableSkipSiteCacheUpdate`), `Tools\Invoke-WarmRunTelemetry.ps1`, and `Tools\Invoke-SharedCacheWarmup.ps1`, auto-restoring settings. Warm harness now emits `WarmRunComparison` even when DB write breakdown is sparse (fallback to `InterfaceSiteCacheMetrics`) and supports hostname filters (`-HostFilter` / `-HostFilterPath`) plus `-RestrictWarmComparisonToColdHosts` to keep cold/warm coverage aligned when extra hosts are present in telemetry. Latest guarded run (`WarmRunTelemetry-20251201-guard-skipdiv4.json`, port diversity guard skipped) shows warm avg 878.33 ms vs cold 884.62 ms (+0.71%), warm providers Cache=620 / Refresh=56 / Hydrate=14 / MissingDatabase=29 (`WarmCacheHitRatioPercent=86.23`, SignatureMatchMissCount=47). Queue summary missing (0 samples); InterfaceSync analyzer warns on missing `Count`. Earlier guarded run (logs moved to `DebugLogs/`) had warm AccessCacheHit=14/AccessRefresh=0 and queue delay p95/p99=0.47/0.87 ms. Snapshot exports now retry with rehydration when cache-module exports are empty and snapshot enumeration falls back to preserved snapshot state (Pester coverage added 2025-12-10). Next: add queue/dispatcher coverage and lift warm cache hit ratio to reduce refreshes. |
| ST-B-010 | Risk register/update loop | PMO + Performance | Backlog | Whenever Plan B metrics slip past gates, add the scenario to `docs/RiskRegister.md` (with mitigation/owner) and reference the telemetry bundle + task board row so Plan G can trace the risk during release planning. |

## Recently delivered
- Restored `InterfaceSyncTiming` telemetry and dispatcher queue instrumentation (2025-10-15 historical log).
- Added warm-run verification thresholds to `VerificationModule` and `Tools\Invoke-StateTraceVerification.ps1` (2025-11-06).
- Authored shared-cache analyzer scripts (`Tools\Analyze-SharedCacheStoreState.ps1`, `Tools\Analyze-SiteCacheProviderReasons.ps1`) and documented the workflow in `docs/CODEX_SHARED_CACHE_DIAGNOSTICS.md`.

## Recent timeline (migrated from consolidated log)
| Date (MT) | Summary | Metrics / Artifacts | Source |
|-----------|---------|---------------------|--------|
| 2025-12-10 11:52 | Hardened shared-cache snapshot export: DeviceRepository.Cache snapshot enumeration now falls back to preserved snapshot state when the live store is empty, and ParserWorker retries snapshot exports when cache-module outputs are empty while rehydrating zero-host entries via `Get-InterfaceSiteCache` (alpha-prefix aware). Added Pester coverage for the empty-store snapshot path. | Tests: `Invoke-Pester 'Modules/Tests/DeviceRepositoryModule.Tests.ps1'`; code updates in Modules/DeviceRepository.Cache.psm1, Modules/ParserWorker.psm1, Modules/DeviceRepositoryModule.psm1; no new telemetry captured this session. | docs/agents/sessions/2025-12-10_session-0062.md |
| 2025-12-10 12:32 | Pipeline smoke on mock corpus (2 logs) with shared-cache diagnostics: auto snapshot export still empty (`SharedCacheSnapshot-20251210-123212.clixml` 82 bytes) even after fallback; diagnostics show `SnapshotImported=24`, `GetHit=118`, `GetMiss=560`, WLLS set/hit activity present. QueueDelay summary written; scheduler streaks pass; warning persists about missing `SampleCount` in queue history. | `Tools\Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -ResetExtractedLogs -RunSharedCacheDiagnostics -DisableSkipSiteCacheUpdate`; artifacts under `Logs/SharedCacheSnapshot/`, `Logs/IngestionMetrics/2025-12-10.json`, `Logs/IngestionMetrics/QueueDelaySummary-2025-12-10.json`. | docs/agents/sessions/2025-12-10_session-0062.md |
| 2025-12-10 12:45 | Queue summary now records SampleCount on delay stats; Update-QueueDelayHistory falls back to Count/root SampleCount to avoid missing-property warnings. Re-appended 2025-12-10 summary to history without errors. | Scripts updated: `Tools/Generate-QueueDelaySummary.ps1`, `Tools/Update-QueueDelayHistory.ps1`; command: `pwsh Tools/Update-QueueDelayHistory.ps1 -QueueSummaryPaths Logs\IngestionMetrics\QueueDelaySummary-2025-12-10.json -Force`. | docs/agents/sessions/2025-12-10_session-0062.md |
| 2025-12-02 13:39 | Guarded host-filter rerun after snapshot rehydration fallback (BOYO/SITE1/WLLS; port diversity guard skipped). Queue summary emitted. Cold/warm host counts align (3/3) but warm regresses (-12.22%: cold avg 493.642 ms / p95 609.798 / max 621.754; warm avg 553.983 ms / p95 858.464 / max 858.464). Warm providers: Cache=325 / Refresh=61 / Hydrate=20 / MissingDatabase=14 (`WarmCacheHitRatioPercent=76.29`, SignatureMatchMissCount=0); cold providers: Cache=1. Snapshot `SharedCacheSnapshot-20251202-133917.clixml` captures SITE1 entry but HostCount=0/TotalRows=0. Next: trace why `Get-InterfaceSiteCache` returns 0 hosts for SITE1 prior to snapshot export and fix cache adoption before rerunning. | `Logs/IngestionMetrics/WarmRunTelemetry-20251202-guard-hostfilter-balanced2.json`, `Logs/IngestionMetrics/2025-12-02.json`, `Logs/IngestionMetrics/QueueDelaySummary-2025-12-02.json`, `Logs/SharedCacheSnapshot/SharedCacheSnapshot-20251202-133917.clixml`, reports under `Logs/Reports/` | docs/agents/sessions/2025-12-02_session-0061.md |
| 2025-12-02 12:56 | Guarded host-filter warm run after seeding queue telemetry via dispatch harness (BOYO-A05-AS-02, SITE1-A01-AS-01, WLLS-A01-AS-01; port diversity guard skipped). Queue summary now emitted (`SampleCount=3`, QueueBuildDelay p95=21.95 ms, QueueBuildDuration p95=27.13 ms). Cold/warm host counts align (3/3); warm still slower (-7.13%: cold avg 517.115 ms / p95 686.688 / max 706.094; warm avg 553.983 ms / p95 858.464 / max 858.464). Warm providers: Cache=315 / Refresh=61 / Hydrate=20 / MissingDatabase=14 (`WarmCacheHitRatioPercent=76.46`, SignatureMatchMissCount=0); cold providers: Cache=1. Next: reduce Refresh/MissingDatabase for these hosts and improve warm timings. | `Logs/IngestionMetrics/WarmRunTelemetry-20251202-guard-hostfilter-balanced2.json`, `Logs/IngestionMetrics/2025-12-02.json`, `Logs/IngestionMetrics/QueueDelaySummary-2025-12-02.json`, `Logs/SharedCacheSnapshot-20251202-125527.clixml`, `Logs/Reports/InterfaceSyncTiming-2025-12-02.json`, `Logs/Reports/PortBatchReady-2025-12-02.json`, `Logs/Reports/ParserSchedulerLaunch-2025-12-02.json` | docs/agents/sessions/2025-12-02_session-0060.md |
| 2025-12-02 12:45 | Host-filtered guarded warm run (BOYO-A05-AS-02, SITE1-A01-AS-01, WLLS-A01-AS-01) after PassLabel/hostless retention fixes. Cold/warm host counts align (3/3). Warm regressed vs cold (-12.84%: cold avg 490.934 ms / p95 624.38 / max 638.937; warm avg 553.983 ms / p95 858.464 / max 858.464). Warm providers: Cache=310 / Refresh=61 / Hydrate=20 / MissingDatabase=14 (`WarmCacheHitRatioPercent=76.35`, SignatureMatchMissCount=0, RewriteTotal=0); cold providers: Cache=1. Queue summary still 0 samples; parser fairness guard passes; shared cache snapshot exported. Next: seed queue telemetry/dispatcher sweep so QueueDelaySummary populates, and reduce Refresh/MissingDatabase for these hosts to recover warm gains. | `Logs/IngestionMetrics/WarmRunTelemetry-20251202-guard-hostfilter-balanced2.json`, `Logs/IngestionMetrics/2025-12-02.json`, `Logs/SharedCacheSnapshot-20251202-124433.clixml`, `Logs/Reports/InterfaceSyncTiming-2025-12-02.json`, `Logs/Reports/PortBatchReady-2025-12-02.json`, `Logs/Reports/ParserSchedulerLaunch-2025-12-02.json` | docs/agents/sessions/2025-12-02_session-0059.md |
| 2025-12-01 15:23 | Guarded warm harness rerun after re-enabling shared cache snapshots (port diversity guard skipped). Warm improved vs cold (+8.95%): warm avg 898.585 ms / p95 1503.905 (max 1687.394, host count 2,566) vs cold avg 986.951 ms / p95 1522.066 (max 1612.029, host count 413). Warm providers: Cache=2,302 / Refresh=182 / Hydrate=20 / MissingDatabase=62 (`WarmCacheHitRatioPercent=89.71`, SignatureMatchMissCount=176, RewriteTotal=0); cold providers: Cache=376 / Refresh=35 / MissingDatabase=2. Shared cache analyzer now reports `SnapshotImported=1`, `InitNewStore=43`, `GetHit=980`, `GetMiss=170` (WLLS/BOYO still dominate misses). Queue summary emitted. Next: lift SnapshotImported beyond 1 and reduce Refresh/MissingDatabase + signature misses before re-enabling port diversity guard. | `Logs/IngestionMetrics/WarmRunTelemetry-20251201-guard-skipdiv7.json`, `Logs/IngestionMetrics/2025-12-01.json`, `Logs/IngestionMetrics/QueueDelaySummary-2025-12-01.json`, `Logs/SharedCacheSnapshot-20251201-152156.clixml`, `Logs/Reports/InterfaceSyncTiming-2025-12-01.json`, `Logs/Reports/PortBatchReady-2025-12-01.json`, `Logs/Reports/ParserSchedulerLaunch-2025-12-01.json` | docs/agents/sessions/2025-12-01_session-0055.md |
| 2025-12-01 15:15 | Guarded warm harness rerun (with queue telemetry seeded; port diversity guard skipped) populated `QueueDelaySummary-2025-12-01.json`. Warm vs cold InterfaceCallDuration: warm avg 870.016 ms / p95 1446.877 (max 1687.394, host count 1,969), cold avg 863.369 ms / p95 1420.322 (max 1516.114, host count 406), net -0.77% improvement. Warm providers: Cache=1,758 / Refresh=140 / Hydrate=20 / MissingDatabase=51 (`WarmCacheHitRatioPercent=89.28`, SignatureMatchMissCount=133, RewriteTotal=0); cold providers: Cache=369 / Refresh=35 / MissingDatabase=2. Shared snapshot captured. | `Logs/IngestionMetrics/WarmRunTelemetry-20251201-guard-skipdiv6.json`, `Logs/IngestionMetrics/QueueDelaySummary-2025-12-01.json`, `Logs/IngestionMetrics/2025-12-01.json`, `Logs/SharedCacheSnapshot-20251201-151407.clixml`, `Logs/Reports/InterfaceSyncTiming-2025-12-01.json`, `Logs/Reports/PortBatchReady-2025-12-01.json`, `Logs/Reports/ParserSchedulerLaunch-2025-12-01.json` | docs/agents/sessions/2025-12-01_session-0053.md |
| 2025-12-01 15:11 | Dispatcher harness sweep captured queue telemetry ahead of the next guarded warm run; 37 host samples with queue delays ~18.8–25.7 ms (all < warning/critical). Balanced host order used. Queue summary still needs to flow into ingestion metrics during the next pipeline/warm pass. | `Logs/DispatchHarness/QueueSweepSummary-20251201.json`, `Logs/DispatchHarness/*-20251201-151143.log` | docs/agents/sessions/2025-12-01_session-0052.md |
| 2025-12-01 15:05 | Guarded warm harness rerun (post provider-count fix) still skipping port diversity guard. Warm host coverage increased (WarmHostCount=1379 vs ColdHostCount=406) but InterfaceCallDuration regressed slightly (-0.65%: warm avg 873.191 ms, cold 867.571 ms). Warm providers: Cache=1,224 / Refresh=98 / Hydrate=17 / MissingDatabase=40 (`WarmCacheHitRatioPercent=88.76`, SignatureMatchMissCount=90, RewriteTotal=0); cold providers: Cache=369 / Refresh=35 / MissingDatabase=2. Queue delay summary still missing samples (0); InterfaceSync analyzer now succeeds. Shared cache snapshot saved. Next: add dispatcher/queue coverage so queue summary populates, then rerun (optionally with port diversity guard on) to drive misses down. | `Logs/IngestionMetrics/WarmRunTelemetry-20251201-guard-skipdiv5.json`, `Logs/IngestionMetrics/2025-12-01.json`, `Logs/SharedCacheSnapshot-20251201-150411.clixml`, `Logs/Reports/InterfaceSyncTiming-2025-12-01.json` | docs/agents/sessions/2025-12-01_session-0051.md |
| 2025-12-01 15:10 | Adjusted warm-run summary logic so `WarmCacheProviderHitCountRaw` / miss counts prefer `InterfaceSiteCacheMetrics` provider data when `DatabaseWriteBreakdown` is sparse (prevents raw counts from showing 0 when summaries contain Cache/Refresh). Will take effect on the next guarded warm run. | `Tools/Invoke-WarmRunTelemetry.ps1` | docs/agents/sessions/2025-12-01_session-0050.md |
| 2025-12-01 14:55 | Guarded cold+warm run after adding a fallback summary path in `Tools\Invoke-WarmRunTelemetry.ps1` (emits `WarmRunComparison` even when DB write breakdown is sparse). Warm improvement +0.71% (avg 878.33 ms vs cold 884.62 ms), warm provider counts Cache=620 / Refresh=56 / Hydrate=14 / MissingDatabase=29 (`WarmCacheHitRatioPercent=86.23`, SignatureMatchMissCount=47, RewriteTotal=0); cold providers Cache=583 / Refresh=49 / Hydrate=9 / MissingDatabase=20. Port diversity guard skipped by flag; queue delay summary failed (0 samples) and InterfaceSync analyzer warned about missing `Count`. Shared cache snapshot captured before warm pass. Next: add queue/dispatcher coverage so the queue summary populates, then rerun to lift warm cache hits and reduce refreshes. | `Logs/IngestionMetrics/WarmRunTelemetry-20251201-guard-skipdiv4.json`, `Logs/IngestionMetrics/2025-12-01.json`, `Logs/SharedCacheSnapshot-20251201-145058.clixml` | docs/agents/sessions/2025-12-01_session-0049.md |
| 2025-12-01 21:20 | Guarded warm-run succeeded after relocating debug/worker logs into `DebugLogs/` and skipping the port diversity guard. Warm pass recorded `AccessCacheHit=14` / `AccessRefresh=0` across BOYO (24 hosts, 240 rows), WLLS (50 hosts, 2,400 rows), SW1 (2 hosts, 96 rows), LABS (2 hosts, 74 rows) with `HostMapSignatureRewriteCount=0`, `HostMapCandidateMissingCount=0`, and `HostMapSignatureMatchCount=2,810`. Cold pass baseline from the same run logged `AccessCacheHit=34` / `AccessRefresh=33` / `SharedCacheUnavailable=7` (BOYO 10/10/2, WLLS 23/23/2, SITE 1/0/3) with no `SkipSiteCacheUpdate` entries. Queue guard passed (SampleCount=12, QueueBuildDelay p95/p99=0.47/0.87 ms; QueueBuildDuration p95/p99=14.55/22.73 ms). | `Logs/IngestionMetrics/WarmRunTelemetry-20251201-guard-skipdiv.json`, `Logs/IngestionMetrics/QueueDelaySummary-2025-12-01.json`, `DebugLogs/2025-12-01.json` | docs/agents/sessions/2025-12-01_session-0048.md |
| 2025-12-01 21:11 | Guarded warm-run retry (`Tools\Invoke-WarmRunTelemetry.ps1 ... -SkipPortDiversityGuard -AssertWarmCache:$false`) completed cold+warm passes but did not emit `WarmRunTelemetry-*.json`. Analyzers threw malformed JSON warnings because debug/worker log slices in `Logs/` polluted `Logs/IngestionMetrics/2025-12-01.json`; port diversity guard was skipped, queue summary wrote, but warm summary is missing. Next: sanitize/relocate debug/worker logs before rerunning with the guard enabled. | `Logs/IngestionMetrics/2025-12-01.json` (polluted), `Logs/IngestionMetrics/QueueDelaySummary-2025-12-01.json`, analyzer warnings in console | docs/agents/sessions/2025-12-01_session-0047.md |
| 2025-12-01 20:59 | Guarded warm-run attempt (`Tools\Invoke-WarmRunTelemetry.ps1 -ColdHistorySeed Empty -WarmHistorySeed ColdOutput -RefreshSiteCaches -AssertWarmCache:$false -VerboseParsing -OutputPath Logs/IngestionMetrics/WarmRunTelemetry-20251201-guard.json`) failed at the port diversity guard (WLLS streak=13 > limit 8) after the cold pass; warm telemetry was not emitted. Mixed debug/worker slices in `Logs/IngestionMetrics/2025-12-01.json` triggered analyzer warnings about malformed JSON lines. Next: rerun with debug/worker logs excluded (or guard disabled for this dataset) to capture warm cache-hit ratios. | `Logs/IngestionMetrics/2025-12-01.json` (warns on analyzer ingest), `Logs/IngestionMetrics/QueueDelaySummary-2025-12-01.json`, `Logs/Reports/PortBatchSiteDiversity-2025-12-01.json` (guard failed) | docs/agents/sessions/2025-12-01_session-0046.md |
| 2025-12-01 13:55 | Ran `Tools\Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -ResetExtractedLogs -DisableSkipSiteCacheUpdate -RunSharedCacheDiagnostics`; guard auto-restored settings. Shared cache: `SnapshotImported=3`, `InitNewStore=3`, `InitReuseStore=6`, `GetMiss=51`, `GetHit=26`. Provider reasons: WLLS `AccessCacheHit=5`, `SkipSiteCacheUpdate=5`; SW1 `SkipSiteCacheUpdate=1`; no `AccessRefresh` events. Queue delay summary emitted; scheduler and port streaks both max=1. Added Pester coverage for the guard module. | `Logs/IngestionMetrics/2025-12-01.json`, `Logs/IngestionMetrics/QueueDelaySummary-2025-12-01.json`, `Logs/Reports/PortBatchReady-2025-12-01.json`, `Logs/Reports/ParserSchedulerLaunch-2025-12-01.json`, `Logs/Reports/SchedulerVsPortDiversity-2025-12-01.json`, `docs/performance/SchedulerVsPortDiversity-2025-12-01.md`, `Modules/Tests/SkipSiteCacheUpdateGuard.Tests.ps1` | This document |
| 2025-12-01 13:45 | Added a shared `SkipSiteCacheUpdate` guard module and wired it into the pipeline (`-DisableSkipSiteCacheUpdate`), warm-run telemetry, and shared-cache warmup so runs can flip the flag off and auto-restore afterward. Updated the runbook to reference the new switch and automatic restoration. | `Tools/SkipSiteCacheUpdateGuard.psm1`, `Tools/Invoke-StateTracePipeline.ps1`, `Tools/Invoke-WarmRunTelemetry.ps1`, `Tools/Invoke-SharedCacheWarmup.ps1`, `docs/CODEX_RUNBOOK.md` | This document |
| 2025-11-28 09:35 | Cold pipeline (`Tools\Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -ResetExtractedLogs -RunSharedCacheDiagnostics`) and the incremental-loading checklist produced updated telemetry: `SnapshotImported=3`, `InitNewStore=15`, `InitReuseStore=6`, `GetMiss=50`, `GetHit=24`; WLLS `AccessCacheHit=5` / `AccessRefresh=0`; BOYO entries remain `Unknown`; queue delay summary still skipped (0 samples). PortBatchReady is still synthetic/minimal (1 sw1 batch) even after dispatcher sweep. Next: rerun with richer host coverage to generate real PortBatchReady + BOYO provider counts, capture queue delay summary, and re-run warm regression. | `Logs/IngestionMetrics/2025-11-28.json`, `Logs/SharedCacheSnapshot/SharedCacheSnapshot-20251128-093502.clixml`, `Logs/Reports/PortBatchReady-2025-11-28-synth.json`, `Logs/Reports/PortBatchSiteDiversity-20251128-095627.json`, `Logs/Reports/SchedulerVsPortDiversity-20251128-095627.json`, `Logs/DispatchHarness/RoutingQueueSweep-checklist-20251128-095600.json` | Tools\Invoke-StateTracePipeline.ps1; Tools\Invoke-IncrementalLoadingChecklist.ps1; Tools\Analyze-SharedCacheStoreState.ps1; Tools\Analyze-SiteCacheProviderReasons.ps1; Tools\Add-PortBatchReadyTelemetry.ps1; Tools\Test-PortBatchSiteDiversity.ps1; Tools\Compare-SchedulerAndPortDiversity.ps1 |
| 2025-12-01 09:57 | Pipeline-only rerun (`Tools\Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -ResetExtractedLogs -VerifyTelemetryCompleteness -FailOnTelemetryMissing -FailOnSchedulerFairness`) still produced no `PortBatchReady` or `InterfaceSyncTiming` events; queue delay summary skipped (0 samples). Shared-cache telemetry incremented (`SnapshotImported=4`, `InitNewStore=16`, `GetHit=31`, `GetMiss=50`), but BOYO provider reasons remain `Unknown`. | `Logs/IngestionMetrics/2025-12-01.json`, `Logs/Reports/PortBatchReady-2025-12-01.json`, `Logs/Reports/InterfaceSyncTiming-2025-12-01.json` (empty), `Logs/Reports/PortBatchSiteDiversity-2025-12-01.json` (guard failed) | Tools\Invoke-StateTracePipeline.ps1 |
| 2025-11-12 19:05 | Created `Tools/Analyze-SharedCacheStoreState.ps1` to summarize `InterfaceSiteCacheSharedStore*` telemetry (SnapshotImported counts, GetMiss/GetHit ratios, top sites). | `Tools/Analyze-SharedCacheStoreState.ps1`, sample output referencing `Logs/IngestionMetrics/2025-11-12.json`. | This document |
| 2025-11-12 19:20 | Ran the provider-reason analyzer against `Logs/IngestionMetrics/2025-11-12.json`: WLLS logged 192 `AccessRefresh` vs 74 `AccessCacheHit` events and BOYO logged 77 refreshes vs zero hits, highlighting missing snapshot imports. | Command: `pwsh Tools\Analyze-SiteCacheProviderReasons.ps1 -Path Logs\IngestionMetrics\2025-11-12.json -IncludeHostBreakdown -TopHosts 10`. | This document |
| 2025-11-12 19:35 | Shared-store telemetry showed `SnapshotImported=0`, `InitNewStore=25`, `GetMiss=1,897` vs `GetHit=1,842` (WLLS = 3,013 ops / 1,148 misses, BOYO = 1,075 ops / 272 misses), confirming every runspace rebuilt the store. | `Tools\Analyze-SharedCacheStoreState.ps1 -Path Logs\IngestionMetrics\2025-11-12.json -IncludeSiteBreakdown`. | This document |
| 2025-11-09 08:12 | Preserved warm run (`Tools\Invoke-WarmRunTelemetry.ps1 ... -OutputPath Logs\IngestionMetrics\WarmRunTelemetry-20251108-run3.json`) showed cold avg 850.19 ms vs warm 851.64 ms (-0.17% improvement) and `WarmCacheHitRatioPercentRaw=0`, prompting the keyed existing-row cache prototype. | Warm-run telemetry JSON + summary in `docs/notes/2025-11-07_warm-run-optimization-plan.md`. | docs/notes/2025-11-07_warm-run-optimization-plan.md |
| 2025-11-13 | Telemetry bundle requirement captured in Plans E/G; Plan B must deposit cold/warm telemetry + analyzer output for every release candidate via `Tools\Publish-TelemetryBundle.ps1`. | `Logs/TelemetryBundles/<date>/` README referencing Plan B ST-B-008/ST-B-010, Plan E ST-E-007, Plan G ST-G-007. | docs/plans/PlanE_Telemetry.md, docs/plans/PlanG_ReleaseGovernance.md |
| 2025-11-13 13:20 | Added `-GenerateDiffHotspotReport [-DiffHotspotTop] [-DiffHotspotOutputPath]` to both `Tools\Invoke-StateTraceVerification.ps1` and `Tools\Invoke-WarmRunTelemetry.ps1`, automatically invoking `Tools\Analyze-WarmRunDiffHotspots.ps1` and exporting CSVs next to warm-run telemetry (e.g., `Logs/IngestionMetrics/DiffHotspots-20251113-132000.csv`). | Verification harness + warm-run telemetry script updates (`Tools\Invoke-AllChecks.ps1 -TelemetryBundlePath Logs/TelemetryBundles/Release-20251113 -RequireTelemetryBundleReady`). | docs/agents/sessions/2025-11-13_session-0011.md |
| 2025-11-13 13:45 | Added `-GenerateSharedCacheDiagnostics [-SharedCacheDiagnosticsDirectory <dir>]` to `Tools\Invoke-StateTraceVerification.ps1`, automatically running the shared-cache analyzers and storing JSON summaries under `Logs/SharedCacheDiagnostics/` (or the supplied directory). | `SharedCacheStoreState-*.json`, `SiteCacheProviderReasons-*.json` generated during verification; see `Tools\Invoke-AllChecks.ps1 -TelemetryBundlePath Logs/TelemetryBundles/Release-20251113 -RequireTelemetryBundleReady`. | docs/agents/sessions/2025-11-13_session-0012.md |

## Automation hooks
- `Tools\Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -ResetExtractedLogs [-DisableSkipSiteCacheUpdate] [-RunSharedCacheDiagnostics]` for cold runs (set `STATETRACE_SHARED_CACHE_SNAPSHOT` when seeding preserved stores; `-DisableSkipSiteCacheUpdate` flips the flag off temporarily via the guard module). 
- `Tools\Invoke-WarmRunRegression.ps1 -VerboseParsing` or `Tools\Invoke-StateTracePipeline.ps1 -RunWarmRunRegression` to capture cold/warm deltas; archive `WarmRunTelemetry-*.json`.
- `Tools\Invoke-StateTraceVerification.ps1 -SharedCacheMinimumSiteCount 2 -SharedCacheRequiredSites BOYO,WLLS -EmitWarmRunTelemetry` (and `Tools\Invoke-StateTraceScheduledVerification.ps1`) to combine pipeline, warm pass, analyzers, and assertions.
- Shared cache diagnostics: `Tools\Invoke-SharedCacheWarmup.ps1`, `Tools\Analyze-SharedCacheStoreState.ps1 -IncludeSiteBreakdown`, `Tools\Analyze-SiteCacheProviderReasons.ps1 -IncludeHostBreakdown` per `docs/CODEX_SHARED_CACHE_DIAGNOSTICS.md`.
- Diff hotspot review: `Tools\Analyze-WarmRunDiffHotspots.ps1 -TelemetryPath Logs\IngestionMetrics\WarmRunTelemetry-<run>.json -Top 20 [-OutputPath Logs\IngestionMetrics\WarmRunDiffHotspots.csv]`.
- Autoscale / overrides: `Import-Module .\Modules\ParserRunspaceModule.psm1; Get-AutoScaleConcurrencyProfile -DeviceFiles <paths>` plus `-ThreadCeilingOverride`, `-MaxWorkersPerSiteOverride`, `-MaxActiveSitesOverride`, `-MaxConsecutiveSiteLaunchesOverride`, `-JobsPerThreadOverride`, `-MinRunspacesOverride`, etc., all recorded in the plan/task board and reset after each run.
- Keyed existing-row cache validation: `Tools\Invoke-WarmRunTelemetry.ps1 -ResetExtractedLogs -ColdHistorySeed Empty -WarmHistorySeed ColdOutput -RefreshSiteCaches -AssertWarmCache:$false -OutputPath <file>` and follow-up analyzers (per warm-run optimization note).
- Evidence bundling: run `Tools\Publish-TelemetryBundle.ps1 -BundleName Release-<date> -PlanReferences PlanB,PlanE,PlanG -TaskBoardIds ST-B-008,ST-E-007,ST-G-007 -Notes "Cold+Warm telemetry + analyzers"` to auto-discover the latest logs and copy them (via `Tools\New-TelemetryBundle.ps1`) into `Logs/TelemetryBundles/<name>/` (include README noting commands + task IDs).

## Telemetry gates
- `DatabaseWriteLatency` p95 < 950 ms (cold) and < 500 ms (warm); alert if warm p95 > 600 ms.
- `InterfaceSiteCacheMetrics.SiteCacheFetchDurationMs` p95 < 5 s (log host-level values > 10 s) and `SnapshotImported > 0` for all parser runspaces.
- `WarmRunComparison.ImprovementPercent ≥ 60` with `WarmProviderCounts.Cache` covering every processed host; `WarmCacheHitRatioPercentRaw` must rise above 0 as keyed cache validation completes.
- `ParseDuration` p95 ≤ 3 s (max ≤ 10 s) and `RowsWritten` within ±1% of Access counts after performance-affecting changes (shared with Plan E but enforced here when tuning ingestion).
- Shared-cache analyzer outputs attached to the plan/task board whenever the cold pass or verification harness runs; failures block release until resolved.
- `InterfaceSiteCacheHostPersisted` counts match the expected host totals per site before signing off on shared snapshot health (log the counts in plan/task updates).

## References & history
- `docs/StateTrace_Consolidated_Plans.md` (Plan B entries) for the historical narrative.
- `docs/CODEX_SHARED_CACHE_DIAGNOSTICS.md` for analyzer workflow.
- `docs/notes/2025-11-07_warm-run-optimization-plan.md` for keyed cache context and telemetry baselines.
- `docs/CODEX_PLAN_AUTOMATION_MATRIX.md` and `docs/CODEX_RUNBOOK.md` for command matrices and override guidance.
- Warm-run telemetry exports: `Logs/IngestionMetrics/WarmRunTelemetry-*.json`; shared cache snapshots and diagnostics under `Logs/SharedCacheSnapshot/` and `Logs/IngestionMetrics/*.json`.
