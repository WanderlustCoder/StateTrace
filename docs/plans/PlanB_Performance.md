# Plan B – Performance & Ingestion Scale

## Objective
Reduce cold- and warm-run latency for parser + persistence + shared cache flows while keeping telemetry exhaustive enough for autonomous troubleshooting. Plan B owns autoscale heuristics, site cache hydration, warm-run verification, and concurrency overrides.

## Current status (2025-11)
- Instrumentation now captures `InterfaceSiteCacheMetrics`, `InterfaceSiteCacheHostPersisted`, and `SiteCacheRecordsetDurationMs` (landed 2025-10-24; see historical log).
- Shared cache normalization (`Normalize-InterfaceSiteCacheEntry`) keeps preserved sessions typed, eliminating cache fallback on warm runs (2025-10-27 entries).
- Warm regression harness (`Tools/Invoke-WarmRunRegression.ps1`) enforces cache-hit ratio ≥99% and improvement ≥60% via `Tools/Invoke-StateTraceVerification.ps1`.
- Outstanding issue: WLLS-A01-AS-01 cold hydrations regressed from ~0.65 s to 2.7 s after autoscale experiments; investigation continues in “Active work”.

## Active work
| ID | Title | Owner | Status | Notes |
|----|-------|-------|--------|-------|
| ST-B-001 | Investigate WLLS snapshot/materialize regression | Ingestion | In Progress | Extended DeviceRepository's host-map exporter (`Convert-InterfaceSiteCacheHostMapToExportMap`) so typed dictionaries retain their per-host entries inside the shared snapshot, and added coverage in `Modules/Tests/DeviceRepositoryModule.Tests.ps1`. Cold pass telemetry is unchanged (WLLS hydrations now average 336 ms, max 471 ms), but the latest preserved warm run (`Tools/Invoke-WarmRunRegression.ps1 -VerboseParsing`, 2025-11-12 ~17:35 MT) still recorded only 124/218 cache hits (84 Refresh, 6 Hydrate, 4 MissingDatabase) with `InterfaceSyncTiming.SiteCacheProviderReason=AccessRefresh` on 74 hosts and `SharedCacheUnavailable` on 12. Need to trace why warm hosts continue to refresh despite host-map export fixes before collecting new warm-run telemetry. |
| ST-B-002 | Trial reduced auto-scale ceilings post-batching | Ingestion | Ready for Review | Cold pass with ceilings=1 logged `DatabaseWriteLatency` avg 387 ms; decision pending on multi-worker requirement. |
| ST-B-003 | Codify concurrency overrides | Automation | Ready | Document override-to-metric mapping in `docs/CODEX_RUNBOOK.md` and task board; ensure overrides reset to 0 post-tests. |
| ST-B-004 | Restore preserved warm-run cache hits | Ingestion | In Progress | Warm regression remains below the gate even after the shared snapshot exporter fix (latest run: 43 hosts processed, WLLS still shows 50 misses and BOYO 24 misses; only 10 `CacheStatus=SharedOnly` events logged). No new `WarmRunTelemetry-*.json` produced because `AssertWarmCache` continues to fail, so keep collecting provider/miss counts from `Logs/IngestionMetrics/2025-11-12.json` and `Logs/warmrun-regression-output.txt` until the AccessRefresh cause is isolated. |

## Recently delivered
- Restored InterfaceSync telemetry and dispatcher queue instrumentation (2025-10-15).
- Added warm-run verification thresholds to `VerificationModule` and `Tools/Invoke-StateTraceVerification.ps1` (2025-11-06).

## Recent timeline (migrated from consolidated log)
| Date (MT) | Summary | Metrics / Artifacts | Source |
|-----------|---------|---------------------|--------|
| 2025-11-12 19:05 | Created `Tools/Analyze-SharedCacheStoreState.ps1` to summarize `InterfaceSiteCacheSharedStore*` telemetry (SnapshotImported counts, GetMiss/GetHit ratios, top sites) so we can quickly verify whether a shared snapshot was imported and which sites still hydrate from Access. | `Tools/Analyze-SharedCacheStoreState.ps1`, sample output referencing `Logs/IngestionMetrics/2025-11-12.json`. | This document |
| 2025-11-12 19:20 | Ran the new provider-reason analyzer against `Logs/IngestionMetrics/2025-11-12.json`: WLLS recorded 192 `AccessRefresh` vs. 74 `AccessCacheHit` events (210 hosts skipped cache updates), and the worst hosts (e.g., WLLS-A05-AS-45) still spend 400-660 ms hydrating. Tool output also shows BOYO’s 77 AccessRefresh vs. zero cache hits, highlighting that warm passes are still bypassing the shared snapshot. Full workflow documented in `docs/CODEX_SHARED_CACHE_DIAGNOSTICS.md`. | Command: `pwsh Tools\Analyze-SiteCacheProviderReasons.ps1 -Path Logs\IngestionMetrics\2025-11-12.json -IncludeHostBreakdown -TopHosts 10`; artifacts noted in CLI summary. | This document |
| 2025-11-12 19:35 | Captured shared-store telemetry via `Tools\Analyze-SharedCacheStoreState.ps1 -Path Logs\IngestionMetrics\2025-11-12.json -IncludeSiteBreakdown`: `SnapshotImported=0`, `InitNewStore=25`, `GetMiss=1,897` vs. `GetHit=1,842`. WLLS dominates store churn (3,013 ops; 1,148 misses) followed by BOYO (1,075 ops; 272 misses). Confirms the cold run never imported a snapshot and every runspace rebuilt its store, explaining the persistent AccessRefresh counts. | Analyzer output recorded in this plan (see above entry) and linked in session log. | This document |
| 2025-11-12 19:55 | Reran the cold pipeline with `-SharedCacheSnapshotPath Logs/SharedCacheSnapshot-20251110-192915.clixml -RunSharedCacheDiagnostics` (warm regression skipped to stay within CLI timeout). Snapshot restoration reported 7 entries but diagnostics still show `SnapshotImported=0`, `InitNewStore=28`, `GetMiss=1,924` vs. `GetHit=2,066`, so the restored cache was cleared before host reuse. Provider analysis now lists WLLS 216 `AccessRefresh` / 74 `AccessCacheHit`, BOYO 88 / 0, and the top offending hosts (e.g., `WLLS-A05-AS-45`) still spend 600+ ms hydrating. Next: trace why shared store initializes anew even after we pass an explicit snapshot (likely module reload between parser worker + store holder). | Command: `pwsh Tools\Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -SharedCacheSnapshotPath Logs/SharedCacheSnapshot-20251110-192915.clixml -RunSharedCacheDiagnostics`; analyzers referencing `Logs\IngestionMetrics\2025-11-12.json`. | This document |
| 2025-11-12 18:45 | Added an env-var backed shared-cache snapshot import so new parser runspaces hydrate before reading Access. `Modules/DeviceRepositoryModule.psm1` now watches `STATETRACE_SHARED_CACHE_SNAPSHOT`, and both pipeline helpers (`Tools/Invoke-StateTracePipeline.ps1`, `Tools/Invoke-WarmRunTelemetry.ps1`) set the variable while running warm passes. | `Modules/DeviceRepositoryModule.psm1`, `Tools/Invoke-StateTracePipeline.ps1`, `Tools/Invoke-WarmRunTelemetry.ps1`, `Modules/Tests/DeviceRepositoryModule.Tests.ps1` | This document |
| 2025-11-12 17:40 | Hardened the shared snapshot exporter so typed host maps keep their per-host cache rows (`Convert-InterfaceSiteCacheHostMapToExportMap` + new DeviceRepository tests) and reran `Tools/Invoke-WarmRunRegression.ps1 -VerboseParsing`. The preserved warm pass still missed the ≥99% gate—218 `InterfaceSiteCacheMetrics` events yielded only 124 cache hits (WLLS miss count 50, BOYO 24; only 10 entries reported `CacheStatus=SharedOnly`) with `InterfaceSyncTiming.SiteCacheProviderReason=AccessRefresh` on 74 hosts. Next step is to follow those AccessRefresh reasons to the site cache hydrator before attempting another warm-run telemetry export. | `Invoke-Pester Modules/Tests/DeviceRepositoryModule.Tests.ps1`, `Logs/IngestionMetrics/2025-11-12.json` (timestamps ≥17:00 MT), `Logs/warmrun-regression-output.txt` (shared snapshot + cache-state logs). | This document |
| 2025-10-15 17:20 | Cold-shell pipeline exposed WLLS-A07-AS-07 hydration costs dominating InterfaceCall duration (14.5 s fetch vs. 16.57 s total). | `Tools/Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -ResetExtractedLogs` run; `SiteCacheFetchDurationMs` logged alongside bulk/stream timings <100 ms. | docs/StateTrace_Consolidated_Plans.md:11 |
| 2025-10-15 17:35 | DeviceRepository instrumentation now emits `InterfaceSiteCacheMetrics`/`SiteCacheFetchStatus`, mirrored into ParserPersistence + DatabaseWriteBreakdown. | `Invoke-Pester Modules/Tests/DeviceRepositoryModule.Tests.ps1` and `Modules/Tests/ParserPersistenceModule.Tests.ps1` updated. | docs/StateTrace_Consolidated_Plans.md:12 |
| 2025-10-15 18:05 | Cleared `Data/IngestionHistory` and reran cold pipeline to capture full telemetry for BOYO/WLLS hydration tails. | `Logs/IngestionMetrics/2025-10-15.json` records BOYO Hydration 4.913 s / WLLS 14.781 s plus per-host `DatabaseWriteBreakdown.SiteCacheFetchDurationMs`. | docs/StateTrace_Consolidated_Plans.md:13 |
| 2025-10-15 18:45 | Stage-level metrics (query, execute, materialize, template, build) wired through `InterfaceSiteCacheMetrics`, revealing ADODB + host-map hotspots. | Example: BOYO Hydration 6.31 s (Query 1.99 s, Materialize 1.97 s); WLLS Hydration 14.42 s. | docs/StateTrace_Consolidated_Plans.md:15 |
| 2025-10-16 11:58 | Fresh cold pass (history cleared) confirmed hydrations now sub-second (max 0.637 s) after instrumentation. | `Logs/IngestionMetrics/2025-10-16.json` shows BOYO/WLLS hydration ≤0.637 s and `DatabaseWriteBreakdown.SiteCacheFetchDurationMs` ≤0.698 s. | docs/StateTrace_Consolidated_Plans.md:16 |
| 2025-10-24 09:33 | Focused cold pass (WLLS history cleared) still showed first host hydrating via Access while others hit cache. | `SiteCacheFetchDurationMs` 1,171.86 ms; `HostMapCandidateMissingCount=1224`. | docs/StateTrace_Consolidated_Plans.md:101 |
| 2025-10-24 11:07 | Landed `HydrationSnapshotRecordsetDurationMs` + `InterfaceSiteCacheHostPersisted` instrumentation with refreshed tests. | `Modules/Tests/DeviceRepositoryModule.Tests.ps1` / `ParserPersistenceModule.Tests.ps1` passing. | docs/StateTrace_Consolidated_Plans.md:105 |
| 2025-10-24 11:15 | Cold replay captured recordset vs. materialize timings (snapshot 992.7 ms vs. materialize 593.27 ms) showing Access still dominant. | See `Logs/IngestionMetrics/2025-10-24.json`. | docs/StateTrace_Consolidated_Plans.md:106 |
| 2025-10-24 13:25 | Port-sort cache audit revealed typed cache entries drop `PortSort`, forcing Gi1/0/1-27 misses; template hints also lack seeded data. | Action: persist sort key/template hints inside `ConvertTo-InterfaceCacheEntryObject`. | docs/StateTrace_Consolidated_Plans.md:117-118 |
| 2025-10-27 14:05 | Shared-cache snapshot normalization keeps typed host dictionaries so preserved sessions reuse caches. | `Normalize-InterfaceSiteCacheEntry` + snapshot helpers updated with tests. | docs/StateTrace_Consolidated_Plans.md:131 |
| 2025-10-27 15:10 | Script-scope caches adopt merged shared-store entries before reuse, preventing warm runs from falling back to refresh. | Regression coverage added (`DeviceRepositoryModule.Tests.ps1`). | docs/StateTrace_Consolidated_Plans.md:134 |
| 2025-10-27 16:05 | Warm verification still reported `SiteCacheProvider=Refresh`, so cache hits were invisible in DatabaseWriteBreakdown. | `Tools/Invoke-StateTraceVerification.ps1 -SkipTests -VerboseParsing` failure; evidence in `Logs/IngestionMetrics/2025-10-27.json`. | docs/StateTrace_Consolidated_Plans.md:135 |
| 2025-10-28 08:46 | ParserPersistence now reads renamed `InterfaceSiteCacheMetrics` fields, but warm verification continued to fail with Provider=Refresh. | `Modules/Tests/ParserPersistenceModule.Tests.ps1` updated; follow-up to reconcile `resolveCachedHost`. | docs/StateTrace_Consolidated_Plans.md:136 |
| 2025-11-06 09:15 | Verification harness enforces warm-run thresholds (improvement ≥25%, cache hit ≥99%) via `Test-WarmRunRegressionSummary`. | `Tools/Invoke-StateTraceVerification.ps1` + `Tools/Invoke-StateTraceScheduledVerification.ps1`; coverage in `Modules/Tests/VerificationModule.Tests.ps1`. | docs/StateTrace_Consolidated_Plans.md:36 |
| 2025-11-06 09:52 | Pipeline auto-imports/exports shared cache snapshots so cold runs hydrate from cache (WLLS fetch now 0 ms). | `Logs/SharedCacheSnapshot/SharedCacheSnapshot-latest.clixml` restored each run; cold pass shows `SiteCacheFetchDurationMs=0`. | docs/StateTrace_Consolidated_Plans.md:37 |
| 2025-11-07 16:20 | `Tools\Invoke-SharedCacheWarmup.ps1` produced snapshots (BOYO 12 hosts/120 rows, WLLS 25/1,200) but warm regression still failed with `WarmCacheProviderHitCount=215`. | Warm telemetry: `WarmCacheProviderMissCount=778`, improvement -1.73%; need to explain `SiteCacheProvider=Unknown/Refresh`. | docs/StateTrace_Consolidated_Plans.md:151 |
| 2025-11-07 17:05 | Added `SiteCacheProviderReason` telemetry to tag cache reuse vs. refresh vs. skipped hydrations, plus unit coverage. | `Modules/ParserPersistenceModule.psm1` + tests updated; next rerun to isolate provider reasons. | docs/StateTrace_Consolidated_Plans.md:152 |
| 2025-11-12 | Ensured cached interface rows retain their `PortSort` values by having `ConvertTo-InterfaceCacheEntryObject` compute the key whenever snapshots omit it; added regression coverage in `DeviceRepositoryModule.Tests.ps1`. | Modules/DeviceRepositoryModule.psm1, Modules/Tests/DeviceRepositoryModule.Tests.ps1, `Invoke-Pester Modules/Tests/DeviceRepositoryModule.Tests.ps1`. | - |
| 2025-11-12 14:35 | Cleared `Data/IngestionHistory/WLLS.json` and ran `Tools\Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -ResetExtractedLogs -DisableSharedCacheSnapshot` (after flipping `SkipSiteCacheUpdate` to `false`). The new telemetry in `Logs/IngestionMetrics/2025-11-12.json` shows 25 WLLS hosts with `SiteCacheFetchStatus=Refreshed` and `SiteCacheUpdateDurationMs` averaging 409 ms (max 485 ms), yet `SiteCacheFetchDurationMs` remains `0` because the provider/ reason fields still report `Cache/NotEvaluated`. Follow-up: fix the instrumentation so refreshed hosts emit real fetch/materialize timings and warm-run cache-hit metrics can be trusted. | Logs/IngestionMetrics/2025-11-12.json, Data/IngestionHistory/WLLS.json, command: `pwsh Tools/Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -ResetExtractedLogs -DisableSharedCacheSnapshot` |
| 2025-11-12 15:14 | Added `Set-InterfaceBulkChunkSize` in ParserPersistence and `Set-InterfacePortStreamChunkSize` in DeviceRepository so parser hints flow into DeviceRepository batching, then re-ran the cold pipeline with shared cache disabled. `Logs/IngestionMetrics/2025-11-12.json` entries stamped 15:14 MT now show 50 WLLS hosts with `SiteCacheFetchStatus=Refreshed`, `SiteCacheFetchDurationMs` averaging 336 ms (max 470.99 ms), and `SiteCacheProvider=Refreshed`/`SiteCacheProviderReason=AccessRefresh`, proving the instrumentation fix captures real Access hydrations again. | Modules/ParserPersistenceModule.psm1, Modules/DeviceRepositoryModule.psm1, `Invoke-Pester Modules/Tests/ParserPersistenceModule.Tests.ps1`, `Invoke-Pester Modules/Tests/ParserWorker.Tests.ps1`, Data/IngestionHistory/WLLS.json, command: `pwsh Tools/Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -ResetExtractedLogs -DisableSharedCacheSnapshot` |
| 2025-11-12 15:45 | `Tools/Invoke-WarmRunRegression.ps1 -VerboseParsing -PassThru` still fails warm-run validation: `Invoke-WarmRunTelemetry.ps1` reports 268 warm hosts without `SiteCacheProvider=Cache` and 412 hosts without `HostMapSignatureMatchCount>0`, so the preserved session keeps refreshing instead of adopting the cache despite the cold-run fixes. No `WarmRunTelemetry-*.json` was emitted because the helper aborts when the assertions fail. | Command: `pwsh Tools/Invoke-WarmRunRegression.ps1 -VerboseParsing -PassThru` (see `warmrun-regression-output.txt`, helper exception at `Tools\Invoke-WarmRunTelemetry.ps1:2543`). |
| 2025-11-12 14:10 | Parsed `Logs/IngestionMetrics/2025-11-10.json` and `2025-11-12.json`: WLLS cold runs now average 24.28 ms fetch (max 138.58 ms) when cache updates are allowed, but the latest run asserted `SkipSiteCacheUpdate` via parameter/module/env so every WLLS InterfaceSync row reported `SiteCacheProvider=Unknown`, `SiteCacheFetchDurationMs=0`, and warm-regression files (`WarmRunTelemetry-20251112-074851.json`) emitted `WarmCacheProviderHitCount=null`. | PowerShell queries under `Logs/IngestionMetrics/2025-11-10.json` / `2025-11-12.json` + `WarmRunTelemetry-20251112-074851.json`; counts: 1070 WLLS rows on 2025-11-10 (677 SkipSiteCacheUpdate, 288 Refresh, 93 Cache) vs. 234 rows on 2025-11-12 (170 SkipSiteCacheUpdate, 64 AccessCacheHit). Next step: rerun pipeline without skip toggles so actual snapshot/materialize timings (incl. >600 ms cases) can be measured again. | Logs/IngestionMetrics/2025-11-10.json, Logs/IngestionMetrics/2025-11-12.json, Logs/IngestionMetrics/WarmRunTelemetry-20251112-074851.json |
| 2025-11-12 14:25 | Re-enabled site-cache adoption by setting `Data/StateTraceSettings.json` → `"SkipSiteCacheUpdate": false` and updated the Codex runbook to remind agents to keep the flag off (or use the warm-run helpers that toggle it) before capturing Plan B telemetry. | Config change + `docs/CODEX_RUNBOOK.md` command matrix note; future cold/warm runs should now record real WLLS fetch/materialize timings instead of `SiteCacheProvider=Unknown`. | Data/StateTraceSettings.json, docs/CODEX_RUNBOOK.md |

## Automation hooks
- `Tools\Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing [-ThreadCeilingOverride <n> ...]` with overrides logged in `docs/StateTrace_TaskBoard.md` and `docs/taskboard/TaskBoard.csv`.
- `Tools\Invoke-WarmRunRegression.ps1 -VerboseParsing` (or `Tools\Invoke-StateTracePipeline.ps1 -RunWarmRunRegression`) to prove cache hit ratios.
- `Tools\Invoke-StateTraceVerification.ps1` to enforce warm-run deltas and shared cache coverage.

## Telemetry gates
- `DatabaseWriteLatency` p95 <950 ms cold, <500 ms warm.
- `InterfaceSiteCacheMetrics.SiteCacheFetchDurationMs` p95 <5 s (alert when >10 s); WLLS regression investigation tracks this.
- `WarmRunComparison.ImprovementPercent` ≥60% with `WarmProviderCounts.Cache` covering every host.
- Document and check thresholds in `docs/telemetry/Automation_Gates.md#plan-b`.

## References & history
- Detailed notes in `docs/StateTrace_Consolidated_Plans.md` (see entries dated 2025-10-15 through 2025-10-27 and 2025-11-06).
- Task board cards ST-B-001 and ST-B-002 summarised at the top of `docs/StateTrace_TaskBoard.md`.
