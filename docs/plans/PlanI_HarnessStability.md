# Plan I - Harness & Gating Stability

<!-- LANDMARK: ST-E-001 telemetry gates link -->
Telemetry gates: [docs/telemetry/Automation_Gates.md](../telemetry/Automation_Gates.md).

## Objective
Ensure cold/warm harnesses (pipeline, verification, warm-run telemetry) consistently produce bundle-ready artifacts???queue summaries, port batch/site diversity, shared-cache diagnostics, diff hotspots???without guard skips or streak failures, using the approved PowerShell 5.1 toolchain.

## Current status (2025-12)
- Queue delay summary now emits when dispatcher sweep precedes runs; the raw synthetic dataset still skews WLLS streaks, but `-ForcePortBatchReadySynthesis` lets the guard evaluate synthesized PortBatchReady events for guarded runs.
- Verification now seeds missing InterfacePortQueueMetrics/InterfacePortStreamMetrics via the headless Interfaces checklist when queue samples are absent, keeping queue summaries and PortBatchReady synthesis deterministic.
- History updaters (`Update-PortBatchHistory.ps1`, `Update-InterfaceSyncHistory.ps1`) succeed when called via 5.1; pipeline now shells them explicitly to avoid `-Depth` errors.
- Warm-run telemetry runs clean with the guard enabled when `-ForcePortBatchReadySynthesis` is used; the raw dataset still triggers streak warnings. Shared cache snapshots load, but provider reasons for BOYO still skew toward `SharedCacheUnavailable/Unknown`.

## Active work
| ID | Title | Owner | Status | Notes |
|----|-------|-------|--------|-------|
| ST-I-001 | Pass diversity guard with balanced input | Ingestion | Done - 2025-12-24 | Added `-ForcePortBatchReadySynthesis` to pipeline/verification/warm-run so the guard can evaluate synthesized PortBatchReady events. Verification harness passed with queue summary, diff hotspots, and shared-cache diagnostics (Logs/IngestionMetrics/2025-12-24.json, Logs/Reports/PortBatchSiteDiversity-2025-12-24.json, Logs/IngestionMetrics/QueueDelaySummary-20251224-100810.json, Logs/IngestionMetrics/WarmRunTelemetry-20251224-100719.json, Logs/IngestionMetrics/DiffHotspots-20251224-100719.csv, Logs/SharedCacheDiagnostics/*.json, docs/performance/SchedulerVsPortDiversity-2025-12-24.md). |
| ST-I-002 | Produce bundle-ready guarded run | Ingestion/PMO | Done - 2025-12-24 | Guarded cold+warm run with synthesis + queue harness produced cold telemetry + queue summary + shared-cache diagnostics + diff hotspots; warm comparison improved 82.58% (cold avg 205.788 ms vs warm avg 35.849 ms, WarmCacheHitRatioPercentRaw=100). Published telemetry bundle `Logs/TelemetryBundles/Release-2025-12-24/Telemetry` with doc-sync checklist `Logs/Reports/DocSyncChecklist-20251224-ST-I-002.json` and readiness summary `Logs/TelemetryBundles/Release-2025-12-24/VerificationSummary.json`. Evidence: `Logs/IngestionMetrics/2025-12-24.json`, `Logs/IngestionMetrics/QueueDelaySummary-2025-12-24.json`, `Logs/IngestionMetrics/WarmRunTelemetry-20251224-110119.json`, `Logs/IngestionMetrics/DiffHotspots-20251224-110119.csv`, `Logs/SharedCacheDiagnostics/SharedCacheStoreState-20251224-110339.json`, `Logs/SharedCacheDiagnostics/SiteCacheProviderReasons-20251224-110339.json`, `Logs/Reports/PortBatchSiteDiversity-2025-12-24.json`. |
| ST-I-003 | Seed warm-run backups & cache snapshots | Ingestion | Done - 2025-12-24 | Warm-run backups created after cold pass (`Data/IngestionHistory/BOYO.json.warmrun.20251224-163619.bak`, `Data/IngestionHistory/WLLS.json.warmrun.20251224-163619.bak`). Shared cache snapshot post-cold: `Logs/SharedCacheSnapshot/SharedCacheSnapshot-20251224-163453.clixml`; latest pointer `Logs/SharedCacheSnapshot/SharedCacheSnapshot-latest.clixml` (updated to `SharedCacheSnapshot-20251224-163620.clixml`). Warm-run log: `Logs/Verification/WarmRunTelemetry-ST-I-003-20251224-163452.log`. AllChecks: `Logs/Verification/AllChecks-ST-I-003-20251224-163203.log`. |
| ST-I-004 | Add harness smoke to task board | Automation | Done - 2025-12-26 | Scheduled synthetic dataset smoke (5.1) now runs end-to-end with dataset-scoped outputs and latest pointer, covering queue summary, port diversity, history updaters, and shared-cache diagnostics. Slices ST-I-012/013/014 delivered. Evidence: `Logs/Verification/SyntheticSmoke-ST-I-014-20251226-162743.log`, `Logs/Reports/SyntheticSmoke/Synthetic-5.1/HarnessSmokeSummary-20251226-162743.json`, `Logs/Reports/SyntheticSmoke/Synthetic-5.1/HarnessSmokeSummary-latest.json`, `Logs/Verification/AllChecks-ST-I-014-20251226-164219.log`. |
| ST-I-012 | Harness smoke summary validator (slice of ST-I-004) | Automation | Done - 2025-12-26 | Added `Tools/Test-HarnessSmoke.ps1` + Pester fixture; harness smoke summary run captured queue summary, port diversity, analyzer outputs, history updates, shared-cache diagnostics. Evidence: `Logs/Verification/HarnessSmoke-ST-I-012-20251226-145135.log`, `Logs/Reports/HarnessSmokeSummary-ST-I-012-20251226-145135.json`, `Logs/Verification/AllChecks-ST-I-012-20251226-150033.log`, `Logs/Reports/DocSyncChecklist-ST-I-012-20251226-150844.json`. |
| ST-I-013 | Scheduled harness smoke runner + default synth mode (slice of ST-I-004) | Automation | Done - 2025-12-26 | Scheduled harness smoke runner defaults to Synth PortBatch diversity mode, writes timestamped summary plus `Logs/Reports/HarnessSmokeSummary-latest.json` pointer, and records PortDiversityMode + artifact paths in the summary. Evidence: `Logs/Verification/ScheduledHarnessSmoke-ST-I-013-20251226-160328.log`, `Logs/Reports/HarnessSmokeSummary-20251226-160328.json`, `Logs/Reports/HarnessSmokeSummary-latest.json`, `Logs/Verification/AllChecks-ST-I-013-20251226-160042.log`, `Logs/Reports/DocSyncChecklist-ST-I-013-20251226-160728.json`. |
| ST-I-014 | Synthetic 5.1 harness smoke runner + stable pointer (slice of ST-I-004) | Automation | Done - 2025-12-26 | Synthetic dataset 5.1 smoke resolves dataset paths and isolates outputs under `Logs/Reports/SyntheticSmoke/Synthetic-5.1`, writing timestamped summary + dataset latest pointer with DatasetId/PortDiversityMode/artifact paths recorded. Evidence: `Logs/Verification/SyntheticSmoke-ST-I-014-20251226-162743.log`, `Logs/Reports/SyntheticSmoke/Synthetic-5.1/HarnessSmokeSummary-20251226-162743.json`, `Logs/Reports/SyntheticSmoke/Synthetic-5.1/HarnessSmokeSummary-latest.json`, `Logs/Verification/AllChecks-ST-I-014-20251226-164219.log`, `Logs/Reports/DocSyncChecklist-ST-I-014-20251226-165100.json`. |
| ST-I-015 | Publish synthetic smoke evidence bundle + runbook canonicalization | Release/Telemetry | Done - 2025-12-27 | Published telemetry bundle `Logs/TelemetryBundles/Release-2025-12-27/Telemetry` with synthetic 5.1 smoke evidence + latest pointer; readiness summary at `Logs/TelemetryBundles/Release-2025-12-27/VerificationSummary.json`. Evidence: `Logs/Verification/PublishBundle-ST-I-015-20251227-091800.log`, `Logs/Reports/DocSyncChecklist-ST-I-015-20251227-091500.json`, `Logs/Verification/AllChecks-ST-I-015-20251227-092200.log`. |
| ST-I-005 | Analyze scheduler vs port diversity mismatch | Ingestion/Automation | Done - 2025-12-24 | Scheduler vs PortBatchReady comparison now records synthesis + input alignment and classifies mismatches as informational when PortBatchReady events are synthesized. Verification run shows mismatch count 2 (BOYO/WLLS) with `MismatchClassification=Informational`, inputs aligned. Evidence: `Logs/Reports/SchedulerVsPortDiversity-2025-12-24.json`, `docs/performance/SchedulerVsPortDiversity-2025-12-24.md`, `Logs/Verification/Verification-ST-I-005-20251224-131744.log`, `Logs/IngestionMetrics/QueueDelaySummary-20251224-131847.json`, `Logs/IngestionMetrics/WarmRunTelemetry-20251224-131744.json`. |
| ST-I-006 | Enforce minimum queue-delay sample size | Automation | Done - 2025-12-24 | Added minimum SampleCount floor (default 10) with InsufficientData failure and rollup guard; queue delay harness now sweeps 12 hosts to meet the floor. Evidence: `Logs/IngestionMetrics/QueueDelaySummary-20251224-121438.json` (SampleCount=20, Result=Pass), `Logs/IngestionMetrics/2025-12-24.json`, `Logs/IngestionMetrics/WarmRunTelemetry-20251224-121344.json`, `Logs/IngestionMetrics/DiffHotspots-20251224-121344.csv`, `Logs/SharedCacheDiagnostics/SharedCacheStoreState-20251224-121344.json`, `Logs/SharedCacheDiagnostics/SiteCacheProviderReasons-20251224-121344.json`. |
| ST-I-007 | Warm-pass optional metrics + deterministic WarmBackup | Ingestion | Done - 2025-12-26 | Verification green after headless Interfaces checklist seeded InterfacePortQueueMetrics/InterfacePortStreamMetrics when missing; queue delay SampleCount=24 (p95 19.212 ms / p99 19.824 ms); PortBatchReady synthesized (48 events) and diversity guard informational with synthesis. Evidence: `Logs/Verification/AllChecks-ST-I-007-FINAL-20251226-093152.log`, `Logs/Verification/Verification-ST-I-007-FINAL-20251226-093349.log`, `Logs/IngestionMetrics/WarmRunTelemetry-20251226-093350.json`, `Logs/IngestionMetrics/QueueDelaySummary-20251226-093535.json`, `Logs/DispatchHarness/RoutingQueueSweep-pipeline-2025-12-26.json`, `Logs/Reports/InterfacesViewChecklist-2025-12-26.json`, `Logs/Reports/PortBatchSiteDiversity-2025-12-26.json`, `Logs/Reports/SchedulerVsPortDiversity-2025-12-26.json`, `docs/performance/SchedulerVsPortDiversity-2025-12-26.md`. |
| ST-I-008 | Investigate raw PortBatchReady streaks > 8 (WLLS) | Ingestion | Done - 2025-12-26 | Raw diversity auto-concurrency pass (`RawPortDiversityAutoConcurrency`) resets Data/IngestionHistory and suppresses manual overrides, producing a raw report with max streak 1 (WLLS) <= 8 and concurrency metadata (ManualOverridesApplied=false). Evidence: `Logs/Verification/Verification-ST-I-008-RAW-AUTO-20251226-122621.log`, `Logs/Reports/PortBatchSiteDiversity-2025-12-26-raw-auto-20251226-122720.json`, `Logs/Verification/Verification-ST-I-008-SYNTH-20251226-122755.log`, `Logs/Verification/AllChecks-ST-I-008-AUTOCONC-20251226-122350.log`. |
| ST-I-009 | Publish Release-2025-12-26 baseline bundle | Release/Telemetry | Done - 2025-12-26 | Release evidence bundle `Logs/TelemetryBundles/Release-2025-12-26` published with raw auto-concurrency diversity baseline and UI harness logs; readiness summary at `Logs/TelemetryBundles/Release-2025-12-26/VerificationSummary.json`. Evidence: `Logs/Verification/AllChecks-ReleaseBaseline-20251226-125554.log`, `Logs/Verification/Verification-ReleaseBaseline-RAW-AUTO-20251226-125404.log`, `Logs/Reports/PortBatchSiteDiversity-2025-12-26-raw-auto-20251226-125510.json`, `Logs/Verification/Verification-ReleaseBaseline-SYNTH-20251226-125926.log`, `Logs/UIHarness/UIHarnessSummary-ReleaseBaseline-20251226-125859.json`, `Logs/Reports/RawAutoSafetyAudit-20251226-125358.json`, `docs/performance/Baseline-2025-12-26.md`. |

## Recently delivered
- History updaters now invoked via PowerShell 5.1 in the pipeline to avoid `-Depth` parameter errors.
- Balanced dispatcher sweep (`RoutingQueueSweep-20251203-153101.json`) with interleaved BOYO/WLLS hosts captured queue delays for harness reuse.

## Automation hooks
- Dispatcher sweep: `Tools\Invoke-RoutingQueueSweep.ps1 -HostListPath Data\RoutingHosts_Balanced.txt -UseBalancedHostOrder` (5.1).
- Guarded warm run: `Tools\Invoke-WarmRunTelemetry.ps1 -GenerateDiffHotspotReport -DisablePreservedRunspacePool` (add `-SkipPortDiversityGuard:$false` once streaks fixed; use 5.1).
- Pipeline cold pass with diagnostics: `Tools\Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -ResetExtractedLogs -DisableSkipSiteCacheUpdate -RunSharedCacheDiagnostics`.
- Bundle: `Tools\Publish-TelemetryBundle.ps1 -BundleName Release-<date> -PlanReferences PlanB,PlanI -TaskBoardIds ST-B-001,ST-I-002`.

## Telemetry gates
- Queue delay summary present with p95 ??? 120 ms, p99 ??? 200 ms (fail guard otherwise).
- Port batch diversity: max streak ??? 8; failure blocks warm pass unless explicitly waived in plan/task updates.
- Warm run: `WarmCacheHitRatioPercentRaw > 0`, provider reasons not `Unknown/SharedCacheUnavailable` for BOYO/WLLS; diff hotspot CSV emitted.
- Shared cache: `SnapshotImported > 0`, `GetHit` improves vs `GetMiss` for BOYO/WLLS.

## References
- `docs/plans/PlanB_Performance.md` (warm-run and shared-cache workstreams).
- `docs/CODEX_RUNBOOK.md` (queue/diff/shared-cache automation matrix).
- `docs/CODEX_SHARED_CACHE_DIAGNOSTICS.md` and `docs/notes/2025-11-07_warm-run-optimization-plan.md` for cache investigations.

