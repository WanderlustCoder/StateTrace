# Plan E – Telemetry & Launch Metrics

## Objective
Capture, roll up, and verify the telemetry needed for operations (Phase 1 dictionary) plus engineering automation. Plan E owns the ingestion metrics schema, rollup scripts, verification harness thresholds, and telemetry documentation.

## Current status (2025-11)
- Phase 1 telemetry dictionary (`docs/telemetry/Phase1_metrics.md`) is live and tracks ParseDuration, DatabaseWriteLatency, RowsWritten, DiffUsageRate, and Drift metrics, but several plan metrics (e.g., Span view usage, PortBatchReady summaries, WarmRunComparison) still lack schema notes or rollup coverage—ST-E-004 remains blocked until every plan updates its schema rows.
- `Tools/Rollup-IngestionMetrics.ps1` plus the wrappers (`Tools/Invoke-DailyMetricRollup.ps1` for ad-hoc runs and `Tools/Invoke-DailyRollupScheduled.ps1` for the scheduled harness) are documented in `docs/CODEX_RUNBOOK.md` and the 2025-11-12 agent session log (`docs/agents/sessions/2025-11-12_session-0002.md`), yet teams have not scheduled them—Plan E must push adoption beyond ad-hoc runs and store artifacts under `Logs/IngestionMetrics/IngestionMetricsSummary-*.csv` with cadence documented in `docs/StateTrace_TaskBoard.md`.
- `docs/CODEX_PLAN_AUTOMATION_MATRIX.md` now routes plan-specific automation back to this plan, so every telemetry script/run needs a matching entry here, on the task board, and inside the doc-sync checklist (`docs/CODEX_DOC_SYNC_PLAYBOOK.md`).
- Warm-run verification ties directly to Plan B; Plan E keeps `docs/telemetry/Automation_Gates.md` current, mirrors cache-related metrics, and must ingest the shared-cache analyzer output plus Plan B's telemetry bundles when publishing rollups so governance reviews have a single reference.
- Plan G relies on Plan E to populate `Logs/TelemetryBundles/<version>/` with rollup CSVs, analyzer output, and warm-run summaries before sign-off; run `Tools\Publish-TelemetryBundle.ps1` (auto-discovers the latest files and calls `Tools\New-TelemetryBundle.ps1`) after each rollup so ST-E-007 (and Plan G ST-G-007) stay unblocked.

## Active work
| ID | Title | Owner | Status | Notes |
|----|-------|-------|--------|-------|
| ST-E-003 | Schedule the daily rollup harness | Telemetry | Done - 2025-12-22 | Re-registered `StateTraceDailyRollup` to call `C:\Users\Werem\Projects\StateTrace\Tools\Invoke-DailyRollupScheduled.ps1 -Days 1 -IncludePerSite -IncludeSiteCache`; on-demand task run reported `Last Result: 1` because no same-day metrics were present, so a manual `Invoke-DailyRollupScheduled.ps1 -Days 30` pass produced `Logs/IngestionMetrics/IngestionMetricsSummary-20251222-060953.csv` (warnings for malformed lines in `2025-12-12.json`). Reran `Tools\Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -ResetExtractedLogs -SkipPortDiversityGuard` to generate same-day metrics, then `schtasks /Run /TN StateTraceDailyRollup` succeeded (Last Result: 0) and wrote `Logs/IngestionMetrics/IngestionMetricsSummary-20251222-071331.csv` (queue delay summary had 0 samples; `InterfaceSyncTiming` summary empty). |
| ST-E-004 | Phase 1 dictionary coverage refresh | Telemetry + Plan owners | Backlog | Compare each metric in `docs/telemetry/Phase1_metrics.md` with the per-plan telemetry gates; add missing schema fields (e.g., `InterfaceSiteCacheMetrics`, `PortBatchReady`, `WarmRunComparison`) and link the updates back to the relevant plan sections. |
| ST-E-005 | Telemetry gate enforcement harness | Automation | Backlog | Extend `Modules/Tests/RollupIngestionMetrics.Tests.ps1` (or add a sibling suite) so `Tools/Rollup-IngestionMetrics.ps1` and `Tools/Invoke-DailyMetricRollup.ps1` validate gate thresholds (`ParseDuration`, `RowsWritten`, `DatabaseWriteLatency`) before publishing CSVs; integrate the checks with `Tools/Invoke-StateTraceVerification.ps1` once complete. |
| ST-E-006 | UI telemetry ingestion (Plan D handoff) | Telemetry + UI | Backlog | Add schema entries for `SpanViewUsage`, `UIRunbookStep`, or equivalent once Plan D emits events; ensure rollups ingest the files and expose the metrics alongside ingestion stats. |
| ST-E-007 | Release-readiness telemetry bundle | PMO + Telemetry | Done - 2025-12-23 | 2025-12-23: Published `Logs/TelemetryBundles/Release-2025-12-23/Telemetry` (README SHA256 `E35558FDF7E72E3DBD966A17B362258C994357D82312B1A71AF425F794080E9B`) with shared-cache analyzers, warm-run summary, diff hotspot CSV (no WarmPass diff entries), and doc-sync `2025-12-23_session-0013.md`; readiness summary `Logs/TelemetryBundles/Release-2025-12-23/VerificationSummary.json`. |
| ST-E-008 | Task board alignment | Telemetry | Backlog | Ensure every telemetry task (ST-E-003 upwards) has a matching entry in `docs/StateTrace_TaskBoard.md` / `docs/taskboard/TaskBoard.csv`; capture the rollup path and telemetry artifacts in the task notes for future agents. |
| ST-E-009 | Plan A telemetry bundle handoff | Telemetry + Routing | Done - 2025-12-23 | 2025-12-23: Published `Logs/TelemetryBundles/Release-2025-12-23/Routing` (README SHA256 `471C2D5AB91599EC1385F718029CD93D965684C5AF933B1E798889306C265982`) with `QueueDelaySummary-2025-12-23.json`, `InterfaceSyncTiming-2025-12-23.json`, routing sweep JSON, and BOYO/WLLS dispatcher logs; readiness summary `Logs/TelemetryBundles/Release-2025-12-23/VerificationSummary.json`. |

## Near-term execution detail

### ST-E-003 - Schedule & operate the daily rollup harness
- **Task creation:** Run `Tools\Schedule-DailyRollupTask.ps1 -TaskName StateTraceDailyRollup -StartTime 02:00 -DaysBack 1 -Force` (skip `-DryRun`) so Windows Task Scheduler launches `powershell.exe -NoProfile -ExecutionPolicy Bypass -File Tools\Invoke-DailyRollupScheduled.ps1 -Days 1 -IncludePerSite -IncludeSiteCache`. Capture the console transcript plus `schtasks /Query /TN StateTraceDailyRollup /V /FO LIST` output and attach both to the TaskBoard row.
- **Cadence documentation:** Update `docs/runbooks/Schedule_Daily_Rollup.md`, `docs/CODEX_RUNBOOK.md` (Plan E section), and `docs/StateTrace_TaskBoard.md` ST-E-003 notes with the run time, output path (e.g., `Logs\IngestionMetrics\IngestionMetricsSummary-<date>.csv`), and the operator fallback command in case the scheduled task fails.
- **Monitoring + resets:** Define a lightweight health check (PowerShell `Test-Path` against the latest CSV timestamp + event log query) and log the result in `docs/agents/sessions/<date>_session-*.md` whenever ST-E-003 is touched. Failures should trigger `Tools\Invoke-DailyRollupScheduled.ps1 -Verbose` (or `Tools\Invoke-DailyMetricRollup.ps1` directly) plus a Plan E log entry documenting remediation per `docs/CODEX_DOC_SYNC_PLAYBOOK.md`.
- **Downstream consumers:** Notify Plan B + Plan G owners (via plan cross-links) that the CSV path is stable so rollup references in their plans can embed the same schedule. The Plan Index entry for Plan E should cite the new cadence so future operators know where to look first.
- **Bundle verification:** After the first scheduled run succeeds, immediately call `Tools\Publish-TelemetryBundle.ps1 -AreaName Telemetry -BundleName Telemetry-<yyyymmdd>` so the new CSV is captured inside `Logs\TelemetryBundles/<bundle>/Telemetry/`, then execute `pwsh Tools\Test-TelemetryBundleReadiness.ps1 -BundlePath Logs\TelemetryBundles\<bundle> -Area Telemetry` (or `pwsh Tools\Invoke-AllChecks.ps1 -SkipPester -SkipSpanHarness -SkipNetOpsLint -TelemetryBundlePath Logs\TelemetryBundles\<bundle> -RequireTelemetryBundleReady`) and capture the output. Record the bundle name plus readiness result inside this plan and the TaskBoard row to prove ST-E-003 fed ST-E-007/ST-G-007.

### ST-E-007 & ST-E-009 - Telemetry bundle production + routing handoff
- **Bundle cadence:** After every cold + warm pipeline pass (or the daily rollup if no release candidate exists), run `Tools\Publish-TelemetryBundle.ps1 -AreaName Telemetry` followed by `Tools\Publish-TelemetryBundle.ps1 -AreaName Routing`. Each invocation writes under `Logs\TelemetryBundles/<bundle>/` with manifests/README hashes; list the exact bundle ID in this plan plus `docs/StateTrace_TaskBoard.md` ST-E-007/ST-E-009 rows, then run `pwsh Tools\Test-TelemetryBundleReadiness.ps1 -BundlePath Logs\TelemetryBundles\<bundle> -Area Telemetry,Routing` (or the `Tools\Invoke-AllChecks.ps1 -TelemetryBundlePath … -RequireTelemetryBundleReady` shortcut) to validate contents.
- **Verification workflow:** Follow `docs/runbooks/Telemetry_Bundle_Verification.md` end-to-end (README hash capture, artifact existence checks, readiness script output) before updating plan/task entries; paste the SHA-256 hashes + verification timestamps into this plan, Plan G ST-G-007, and the Task Board row.
- **Required payload:** Minimum files per bundle: latest rollup CSV, `SharedCacheStoreState` / `SiteCacheProviderReasons` output, warm-run summary JSON, diff-hotspot CSV, doc-sync checklist artifact, and for the routing area, `Logs\IngestionMetrics\QueueDelaySummary-<timestamp>.json` plus `InterfaceSyncTiming` JSON + dispatcher harness export. Update `docs/CODEX_RUNBOOK.md` so future agents know to stash doc-sync output alongside telemetry, and ensure `docs/CODEX_PLAN_AUTOMATION_MATRIX.md` references both bundle commands.
- **Governance integration:** Coordinate with Plan G ST-G-007 so `docs/Release.md` cites the bundle folder as a release prerequisite. Until automation exists, add a manual verification step to the release checklist referencing the README hash (makes tampering obvious), document the check in `docs/StateTrace_TaskBoard.md`, and link the same evidence inside `docs/Release.md`’s telemetry gate section.
- **Evidence logging:** Each bundle README must cite the commands executed, timestamps, TaskBoard IDs (ST-E-003/7/8/9, ST-G-007), and any overrides used (thread ceilings, net flags). Copy the README snippet into this plan's timeline and archive the hash under `docs/telemetry/Automation_Gates.md` appendices to preserve provenance.

## Recently delivered
| ID | Date | Summary | Evidence |
|----|------|---------|----------|
| ST-E-001 | 2025-11-06 | Published `docs/telemetry/Automation_Gates.md` and linked every plan/task to the shared telemetry thresholds. | `docs/telemetry/Automation_Gates.md`, plan updates, task board entries. |
| ST-E-002 | 2025-11-12 | Added `Tools/Invoke-DailyMetricRollup.ps1`, updated README + Codex Runbook so daily ingestion summaries can be generated (and scheduled) with one command. | `Tools/Invoke-DailyMetricRollup.ps1`, `docs/README.md`, `docs/CODEX_RUNBOOK.md`. |

## Automation hooks
- `Tools\Invoke-DailyMetricRollup.ps1 -Days 1 -IncludePerSite -IncludeSiteCache [-OutputPath Logs\IngestionMetrics\IngestionMetricsSummary-<timestamp>.csv]` to generate timestamped daily summaries (useful for automation or Task Scheduler).
- `Tools\Rollup-IngestionMetrics.ps1 -MetricsDirectory Logs\IngestionMetrics -OutputPath Logs\IngestionMetrics\IngestionMetricsSummary.csv [-IncludePerSite -IncludeSiteCache -Start <date> -End <date>]` for ad-hoc or multi-day investigations.
- `Tools\Schedule-DailyRollupTask.ps1 -TaskName StateTraceDailyRollup -StartTime 02:00 [-MetricsDirectory <path> -OutputDirectory <path>]` to register (or preview via `-DryRun`) a Windows scheduled task that runs the wrapper harness (see `docs/runbooks/Schedule_Daily_Rollup.md`).
- `Tools\Invoke-DailyRollupScheduled.ps1 -Days 1 -IncludePerSite -IncludeSiteCache [-MetricsDirectory <path> -OutputDirectory <path>]` when you need to reproduce the scheduled run manually; the wrapper resolves repo-relative directories and forwards switches to `Tools\Invoke-DailyMetricRollup.ps1`.
- `pwsh -NoLogo -Command "Invoke-Pester Modules/Tests/RollupIngestionMetrics.Tests.ps1"` after modifying telemetry schemas or rollup scripts to ensure coverage stays green.
- `pwsh Tools\Analyze-SharedCacheStoreState.ps1 -Path Logs\IngestionMetrics\<file>.json -IncludeSiteBreakdown` (optional) so cache-related telemetry captured for Plan B is also recorded here when Plan E publishes summaries.
- `pwsh Tools\Analyze-WarmRunDiffHotspots.ps1 -TelemetryPath Logs\IngestionMetrics\WarmRunTelemetry-<run>.json -Top 20` when consuming preserved warm-run data for dashboards, ensuring the diff metrics referenced in Phase 1 dictionary are populated.
- Bundle handoff: after each rollup, run `Tools\Publish-TelemetryBundle.ps1` (see `docs/CODEX_RUNBOOK.md`) to auto-discover the latest CSV + analyzer output + warm-run summaries and copy them into `Logs/TelemetryBundles/<date>/` (include a README listing commands and task IDs) so Plan G can reference a single artifact per release (see `docs/CODEX_DOC_SYNC_PLAYBOOK.md`).
- Verification: apply `docs/runbooks/Telemetry_Bundle_Verification.md` (README hashes + readiness script) whenever bundles are produced so Plan E/G evidence stays consistent.
- Reporting: use `Tools\Show-TelemetryBundleSummary.ps1 -BundlePath Logs\TelemetryBundles\<bundle>` to reprint the stored README hashes and requirement status (from `VerificationSummary.json`) while updating plans/task board entries.

## Recent timeline (migrated from consolidated log)
| Date (MT) | Summary | Metrics / Artifacts | Source |
|-----------|---------|---------------------|--------|
| 2025-12-23 13:35 | Published Release-2025-12-23 Telemetry + Routing bundles and ran readiness checks. | Telemetry README SHA256 `E35558FDF7E72E3DBD966A17B362258C994357D82312B1A71AF425F794080E9B`; Routing README SHA256 `471C2D5AB91599EC1385F718029CD93D965684C5AF933B1E798889306C265982`; `Logs/TelemetryBundles/Release-2025-12-23/VerificationSummary.json`; `Logs/IngestionMetrics/SharedCacheStoreState-2025-12-23.json`; `Logs/IngestionMetrics/SiteCacheProviderReasons-2025-12-23.json`; `Logs/IngestionMetrics/WarmRunDiffHotspots-20251222-170626.csv` (no WarmPass diff entries). | Tools/Publish-TelemetryBundle.ps1, Tools/Test-TelemetryBundleReadiness.ps1 |
| 2025-12-22 06:09 | Re-registered `StateTraceDailyRollup` to the repo path and ran a manual rollup (`Invoke-DailyRollupScheduled.ps1 -Days 30`) after the on-demand task run failed due to missing same-day metrics. | `Logs/IngestionMetrics/IngestionMetricsSummary-20251222-060953.csv` (warnings about malformed lines in `Logs/IngestionMetrics/2025-12-12.json`). | This document |
| 2025-12-22 07:13 | Ran `Tools\Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -ResetExtractedLogs -SkipPortDiversityGuard` to generate same-day metrics, then reran the scheduled rollup (`schtasks /Run /TN StateTraceDailyRollup`, Last Result: 0). | `Logs/IngestionMetrics/2025-12-22.json`, `Logs/IngestionMetrics/IngestionMetricsSummary-20251222-071331.csv`, `Logs/Reports/PortBatchReady-2025-12-22.json`, `Logs/Reports/InterfaceSyncTiming-2025-12-22.json`, `Logs/Reports/ParserSchedulerLaunch-2025-12-22.json`, `Logs/SharedCacheSnapshot/SharedCacheSnapshot-20251222-071303.clixml`. | docs/agents/sessions/2025-12-22_session-0002.md |
| 2025-11-13 12:30 | Ran the daily rollup + analyzer suite (`IngestionMetricsSummary-20251113-122959.csv`, shared-cache/site-provider summaries, DiffHotspots-20251110-173500.csv) and published `Logs/TelemetryBundles/Release-20251113/Telemetry/` before executing `Tools\Test-TelemetryBundleReadiness.ps1 -BundlePath Logs/TelemetryBundles/Release-20251113 -Area Telemetry,Routing`. | `Logs/IngestionMetrics/IngestionMetricsSummary-20251113-122959.csv`, `Logs/IngestionMetrics/SharedCacheStoreState-20251113.json`, `Logs/IngestionMetrics/SiteCacheProviderReasons-20251113.json`, `Logs/IngestionMetrics/DiffHotspots-20251110-173500.csv`, readiness output. | Tools/Invoke-DailyMetricRollup.ps1, Tools/Publish-TelemetryBundle.ps1, Tools/Test-TelemetryBundleReadiness.ps1 |
| 2025-11-13 13:35 | Reran the registered `StateTraceDailyRollup` task via `schtasks /Run /TN StateTraceDailyRollup`, confirmed `Last Result: 0` (`schtasks /Query /V /FO LIST`) and captured the scheduled CSV `Logs/IngestionMetrics/IngestionMetricsSummary-20251113-133544.csv` plus analyzer output for Plan E/G bundles. | `schtasks /Query /TN StateTraceDailyRollup /V /FO LIST`, `Logs/IngestionMetrics/IngestionMetricsSummary-20251113-133544.csv`. | This document |
| 2025-11-13 13:50 | Enhanced `Tools\Test-TelemetryBundleReadiness.ps1` to compute README hashes and emit `VerificationSummary.json`; validated `Logs/TelemetryBundles/Release-20251113` (Telemetry README SHA256 `402834EC33AC2A75B15EBBDFE6E5AAACF449CD82942AAB6CF97A79CE1CAAF09B`, Routing SHA256 `CD6B04DE8F34A0DCAC64FCF79C6380C91167FE7BEE8796DF14234B29703610F6`) and stored the readiness summary. | Readiness output + `Logs/TelemetryBundles/Release-20251113/VerificationSummary.json`. | Tools/Test-TelemetryBundleReadiness.ps1 |
| 2025-11-06 12:24 | Delivered `Tools/Rollup-IngestionMetrics.ps1` to summarise ingestion metrics (totals, averages, p95) with optional per-site/site-cache slices for regression tracking. | Script coverage in `Modules/Tests/RollupIngestionMetrics.Tests.ps1`; README/telemetry dictionary updated to advertise the command. | docs/StateTrace_Consolidated_Plans.md:38 |
| 2025-11-12 | Added `Tools/Invoke-DailyMetricRollup.ps1` and refreshed README + Codex Runbook guidance so daily CSV exports are one command away; session log captured the workflow. | `Tools/Invoke-DailyMetricRollup.ps1`, `docs/README.md`, `docs/CODEX_RUNBOOK.md`, `docs/agents/sessions/2025-11-12_session-0002.md`. | docs/agents/sessions/2025-11-12_session-0002.md |
| 2025-11-12 19:35 | Shared-cache analyzer output (Plan B) identified `SnapshotImported=0` and high AccessRefresh counts; Plan E must capture these files with the rollups so telemetry bundles include cache status. | `Tools/Analyze-SharedCacheStoreState.ps1`, `Tools/Analyze-SiteCacheProviderReasons.ps1`, `Logs/IngestionMetrics/2025-11-12.json`. | docs/plans/PlanB_Performance.md, docs/CODEX_SHARED_CACHE_DIAGNOSTICS.md |
| 2025-11-13 | Plan G dependency noted: release candidates must cite `Logs/TelemetryBundles/<version>/` with rollup CSVs + analyzer outputs; Plan E owns running `Tools/New-TelemetryBundle.ps1` after each cold/warm run. | Telemetry bundle checklist referenced in Plan G ST-G-007 and TaskBoard ST-E-003/007 rows. | docs/plans/PlanG_ReleaseGovernance.md, docs/StateTrace_TaskBoard.md |
| 2025-11-13 13:55 | Ran `Tools\Schedule-DailyRollupTask.ps1 -TaskName StateTraceDailyRollup -StartTime 02:00 -MetricsDirectory Logs\IngestionMetrics -OutputDirectory Logs\IngestionMetrics -IncludePerSite -IncludeSiteCache -DryRun` to verify the scheduled-task command before registering ST-E-003's job. | Dry-run output showing `schtasks.exe /Create /SC DAILY /TN StateTraceDailyRollup … /ST 02:00`. | docs/agents/sessions/2025-11-13_session-0013.md |

## Telemetry gates
- See `docs/telemetry/Automation_Gates.md` for per-plan tables; Plan E maintains that file.
- `ParseDuration` p95 target <= 3 s, max <= 10 s.
- `DatabaseWriteLatency` p95 <= 500 ms (Plan B) with alerts at 950 ms cold.
- `RowsWritten` sums per site stay within +/-1% of Access counts; record comparisons inside the generated CSV and session notes.
- `Logs/IngestionMetrics/IngestionMetricsSummary*.csv` (or the timestamped variant) must be refreshed within 24 hours of telemetry-impacting changes.
- `Logs/TelemetryBundles/<date>/` exists for every release candidate (includes rollup CSV, shared-cache analyzers, warm-run summary, doc-sync checklist artifact). 

## References & history
- Historical notes remain in `docs/StateTrace_Consolidated_Plans.md` under Plan E sections.
- Telemetry specs + gates: `docs/telemetry/Phase1_metrics.md`, `docs/telemetry/Automation_Gates.md`.
- Automation references: `docs/CODEX_RUNBOOK.md`, `docs/CODEX_PLAN_AUTOMATION_MATRIX.md`, `docs/agents/sessions/2025-11-12_session-0002.md`.
- Scripts/tests: `Tools/Rollup-IngestionMetrics.ps1`, `Tools/Invoke-DailyMetricRollup.ps1`, `Modules/Tests/RollupIngestionMetrics.Tests.ps1`.
- Runbook references: `docs/runbooks/Schedule_Daily_Rollup.md`.
- Warm-run telemetry exports: `Logs/IngestionMetrics/WarmRunTelemetry-*.json`.
- Shared-cache diagnostics & bundles: `docs/CODEX_SHARED_CACHE_DIAGNOSTICS.md`, `Logs/SharedCacheSnapshot/`, `Logs/ReleaseEvidence/` (once created).









