# Codex Runbook – Install, Run, Test

This runbook maps common automation tasks to the exact commands, required inputs, telemetry captures, and follow-up docs. Use it alongside `docs/CODEX_AUTONOMY_PLAN.md` and the per-plan files.

## Command matrix
| Task | Commands | Notes | Telemetry / evidence |
|------|----------|-------|----------------------|
| Full test suite | `Invoke-Pester Modules/Tests` | Run before every commit; capture summary. | Paste final Pester line into session log. |
| Cold ingestion pass | `Tools\Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -ResetExtractedLogs [-RunSharedCacheDiagnostics]` | Run from repo root; restores shared cache snapshots. When you supply `-SharedCacheSnapshotPath` the harness sets `STATETRACE_SHARED_CACHE_SNAPSHOT` so every parser runspace imports that snapshot before touching Access (set the env var manually if you seed the cache outside the helper). Add `-RunSharedCacheDiagnostics` to automatically call the shared-cache analyzers against the latest `Logs/IngestionMetrics/*.json`. Ensure `Data/StateTraceSettings.json` has `\"SkipSiteCacheUpdate\": false` (or call the warm-run helpers that temporarily disable it) before collecting Plan B telemetry. The parser scheduler fairness guard now runs automatically; only pass `-FailOnSchedulerFairness:$false` (and log why) when replaying partial telemetry. | Attach `Logs/IngestionMetrics/<date>.json` snippet (ParseDuration, DatabaseWriteLatency, InterfaceSiteCacheMetrics). |
| Cold + warm regression | `Tools\Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -RunWarmRunRegression` *or* `Tools\Invoke-WarmRunRegression.ps1 -VerboseParsing` | Harness preserves parser runspaces, exports the shared snapshot after the cold pass, and wires up `STATETRACE_SHARED_CACHE_SNAPSHOT` so the warm pass reuses the exact cache contents. Include overrides when experimenting; reset afterwards. Scheduler fairness enforcement is built in—only disable it with `-FailOnSchedulerFairness:$false` when inspecting legacy telemetry and capture the rationale in the plan/task entry. | WarmRunTelemetry JSON + improvement summary recorded in plan/task board. |
| Warm-run telemetry capture | `Tools\Invoke-WarmRunTelemetry.ps1 [-IncludeTests] [-SkipSchedulerFairnessGuard] [-GenerateDiffHotspotReport [-DiffHotspotTop <n>] [-DiffHotspotOutputPath <file>]]` | Runs the warm-run pipeline, exports `Logs\IngestionMetrics\WarmRunTelemetry-<timestamp>.json`, and (with `-GenerateDiffHotspotReport`) automatically calls `Tools\Analyze-WarmRunDiffHotspots.ps1` so a `DiffHotspots-<timestamp>.csv` lands alongside the telemetry. Leave the parser fairness guard enabled unless you explicitly pass `-SkipSchedulerFairnessGuard` for a targeted investigation (log the reason when you do). Use `-DiffHotspotOutputPath` to point the CSV somewhere specific. | Reference the telemetry JSON + diff hotspot CSV paths in plan/task updates and stash both inside the telemetry bundle. |
| Verification harness + queue gate | `Tools\Invoke-StateTraceVerification.ps1 [-SkipSchedulerFairnessGuard] [-QueueMetricsPath <path>] [-QueueDelayP95Maximum <ms> -QueueDelayP99Maximum <ms>] [-SkipQueueDelayEvaluation] [-QueueDelaySummaryPath <path>] [-GenerateDiffHotspotReport [-DiffHotspotTop <n>] [-DiffHotspotOutputPath <file>]] [-GenerateSharedCacheDiagnostics [-SharedCacheDiagnosticsDirectory <dir>]] [-TelemetryBundlePath Logs\TelemetryBundles\<bundle> -VerifyTelemetryBundleReadiness [-TelemetryBundleAreas Telemetry,Routing]]` | Runs the verification harness (pipeline, warm regression, shared-cache checks) and enforces `InterfacePortQueueMetrics.QueueBuildDelayMs` limits (p95 <=120 ms, p99 <=200 ms). Scheduler fairness now gates the pipeline automatically; only add `-SkipSchedulerFairnessGuard` (and note it in the plan) when replaying incomplete telemetry. `-GenerateDiffHotspotReport` automatically calls `Tools\Analyze-WarmRunDiffHotspots.ps1`; `-GenerateSharedCacheDiagnostics` runs the shared-cache analyzers and saves JSON summaries for release evidence. Use the telemetry bundle parameters to call the readiness script automatically after the harness finishes (same coverage as `Tools\Test-TelemetryBundleReadiness.ps1`). Only skip the queue delay evaluation when telemetry is unavailable and document the reason. | Record warm-run summary path, queue-gate console output (avg/p95/p99/max), the generated `Logs\IngestionMetrics\QueueDelaySummary-<timestamp>.json`, the `Logs\IngestionMetrics/<date>.json` source, diff hotspot CSV path, shared-cache diagnostics paths, and the readiness output (bundle path + areas) in the plan/task update.
| Autoscale profile inspection | `Import-Module .\Modules\ParserRunspaceModule.psm1; Get-AutoScaleConcurrencyProfile -DeviceFiles <paths>` | Use when tuning overrides; log resolved ceilings. | Screenshot or text snippet of resolved profile + overrides. |
| Parser scheduler rotation audit | `pwsh Tools\Analyze-ParserSchedulerLaunch.ps1 -Path Logs\IngestionMetrics\<date>.json -MaxAllowedStreak 8 -OutputPath Logs\Reports\ParserSchedulerLaunch-<date>.json` | Consumes `ParserSchedulerLaunch` telemetry to show launch counts by site, longest streaks, and scheduler resource stats. `Tools\Invoke-StateTracePipeline.ps1` now runs this analyzer automatically (writes `Logs/Reports/ParserSchedulerLaunch-<metrics>.json`), but rerun it whenever you need to inspect historical telemetry or custom streak thresholds. | Attach the JSON report path and note any streak violations in the plan/task update + telemetry bundle. |
| Incremental telemetry completeness | `pwsh Tools\Test-IncrementalTelemetryCompleteness.ps1 -MetricsPath Logs\IngestionMetrics\<date>.json -RequirePortBatchReady -RequireInterfaceSync -RequireSchedulerLaunch [-ThrowOnMissing]` | Verifies that a telemetry file contains the required incremental-loading signals; use `-ThrowOnMissing` (or pass `-VerifyTelemetryCompleteness -FailOnTelemetryMissing -SynthesizeSchedulerTelemetryOnMissing` to `Tools\\Invoke-StateTracePipeline.ps1`) so pipeline runs fail fast when scheduler/UI data is absent and synthesize scheduler launches when a rerun is not possible. | Record the command output (counts + missing signals) in the plan/task update. Block ST-D-003/ST-A-001 closures until the script passes. |
| Incremental-loading automation | `pwsh Tools\Invoke-IncrementalLoadingChecklist.ps1 -MaxHosts 20 -SiteFilter WLLS,BOYO [-SkipPipeline] [-SkipHarness] [-ForceTelemetrySynthesis]` | Orchestrates the cold parser pipeline, dispatcher harness sweep, telemetry synthesis, completeness test, and the diversity/scheduler analyzers so we can refresh Plan A/D evidence without touching the WPF UI. Use the flags to reuse an existing metrics file or to skip the harness when replicating historical data. | Capture the console summary + returned JSON (metrics path, sweep summary, PortBatchSiteDiversity JSON, scheduler-vs-port markdown) in the plan/task update and stash the artifacts in the telemetry bundle. |
| Headless Interfaces view session | `pwsh -NoLogo -STA -File Tools\Invoke-InterfacesViewChecklist.ps1 -SiteFilter WLLS,BOYO -MaxHosts 10 [-Hostnames <array>] [-OutputPath <file>] [-PassThru]` | Hosts the Interfaces view inside a hidden window, cycles through each host, streams incremental batches via the dispatcher, and records per-host success metrics while the normal UI telemetry (`PortBatchReady`, `InterfaceSyncTiming`, `DeviceDetailsLoadMetrics`) is emitted. Use when a “real UI” incremental-loading run is required but an interactive desktop is unavailable. | Attach the output JSON (or PassThru summary) plus the associated telemetry paths (Logs/IngestionMetrics/*.json, PortBatchSiteDiversity JSON, scheduler-vs-port markdown) to Plan D ST-D-010/Task Board updates and copy everything into the telemetry bundle. |
| Scheduler vs. Port streak correlation | `pwsh Tools\Compare-SchedulerAndPortDiversity.ps1 -SchedulerReportPath Logs\Reports\ParserSchedulerLaunch-<date>.json -PortDiversityReportPath Logs\Reports\PortBatchSiteDiversity-<date>.json -OutputPath Logs\Reports\SchedulerVsPortDiversity-<date>.json -MarkdownPath docs\performance\SchedulerVsPortDiversity-<date>.md` | Compares parser scheduler launch streaks with PortBatchReady site streaks so ST-D-010 can prove whether the UI still replays hosts despite the guard. | Attach the generated markdown/JSON to Plan D updates and drop it into the telemetry bundle beside the analyzer outputs. |
| Metrics rollup | `Tools\Rollup-IngestionMetrics.ps1 ...` or `Tools\Invoke-DailyMetricRollup.ps1 -Days 1 -IncludePerSite -IncludeSiteCache` | Run when telemetry changes; the daily wrapper filters the latest files and emits `IngestionMetricsSummary-<timestamp>.csv`. | Mention output path + date in plan/task update (and check summary into docs/Logs when requested). |
| Telemetry bundle export | `Tools\Publish-TelemetryBundle.ps1 -BundleName Release-20251113 -PlanReferences PlanB,PlanE,PlanG -TaskBoardIds ST-B-008,ST-E-007,ST-G-007 -Notes "Cold+Warm telemetry + analyzer outputs"` | Auto-discovers the latest cold telemetry, warm telemetry, shared-cache analyzers, diff-hotspot CSV, rollup summary, queue/scheduler history CSVs, and session log, then calls `Tools\New-TelemetryBundle.ps1` to copy them (plus hashes) into `Logs/TelemetryBundles/<BundleName>/[Area]`. Use `-AreaName Routing` when capturing Plan A dispatcher evidence. | Record the bundle path inside the relevant plan/timeline entry and TaskBoard row so release approvals can reference it. |
| Telemetry bundle verification | `pwsh Tools\Test-TelemetryBundleReadiness.ps1 -BundlePath Logs\TelemetryBundles\<bundle> -Area Telemetry,Routing -IncludeReadmeHash -SummaryPath <path>` (see `docs/runbooks/Telemetry_Bundle_Verification.md`) or `Tools\Invoke-AllChecks.ps1 -TelemetryBundlePath Logs\TelemetryBundles\<bundle> -RequireTelemetryBundleReady -SkipPester -SkipSpanHarness` during CI wrap-up | Run immediately after exporting Telemetry + Routing bundles so Plan E/G can cite verified contents/hashes. Script throws when required artifacts (rollup CSV, analyzers, warm run JSON, queue summaries, dispatcher logs, doc-sync evidence) are missing and emits README hash tables + a JSON summary for provenance. | Paste README hashes, manifest path, verification timestamp, and summary file path into Plan E ST-E-007/009, Plan G ST-G-007, and TaskBoard rows. |
| Display bundle summary | `pwsh Tools\Show-TelemetryBundleSummary.ps1 -BundlePath Logs\TelemetryBundles\<bundle> [-SummaryPath <path>] [-PassThru]` | Renders the hashes + requirement status stored in `VerificationSummary.json` so operators can reference prior readiness runs without reprocessing the bundle. | Useful when filling in release notes, plan timelines, or reviewing historical bundles. |
| Incremental-loading telemetry analysis | `pwsh Tools\Analyze-PortBatchReadyTelemetry.ps1 -Path Logs\IngestionMetrics\<file>.json -IncludeHostBreakdown -OutputPath Logs\Reports\PortBatchReady-<date>.json` | Summarises `PortBatchReady` + `InterfaceSyncTiming` events (throughput, host coverage, UiClone/Stream/Diff durations) so Plan D can document UI performance baselines. | Attach the console summary + JSON report to Plan D ST-D-003 and Task Board updates whenever UI performance is questioned. |
| InterfaceSyncTiming sweep | `pwsh Tools\Analyze-InterfaceSyncTiming.ps1 -Path Logs\IngestionMetrics\<file>.json -OutputPath Logs\Reports\InterfaceSyncTiming-<date>.json -TopHosts 15` | Highlights per-site/host UiClone + StreamDispatch hot spots so UI perf regressions surface quickly (pairs with incremental-loading analysis). | Log the JSON path + top offenders in Plan D notes/task board when diagnosing UI latency. |
| Port batch gap detection | `pwsh Tools\Analyze-PortBatchIntervals.ps1 -Path Logs\IngestionMetrics\<file>.json -TopIntervals 10 -ThresholdSeconds 60` | Lists the longest idle windows between PortBatchReady events so throttling/idled queues are obvious. | Record any gaps ≥60 s in Plan D and open follow-up actions if they persist. |
| Schedule rollup task | `Tools\Schedule-DailyRollupTask.ps1 -TaskName StateTraceDailyRollup -StartTime 02:00 [-MetricsDirectory <path> -OutputDirectory <path> -DryRun]` | Registers (or previews) a Windows Task Scheduler job that runs the wrapper `Tools\Invoke-DailyRollupScheduled.ps1` (which calls `Tools\Invoke-DailyMetricRollup.ps1`) daily so ST-E-003 stays compliant. | Record the task name/time and resulting CSV path in Plan E + Task Board row ST-E-003. |
| Routing queue sweep | `Tools\Invoke-RoutingQueueSweep.ps1 -HostListPath Data\RoutingHosts.txt [-Hosts <array>] [-QueueDelayWarningMs 120 -QueueDelayCriticalMs 200]` | Automates dispatcher harness runs for multiple hosts by calling `powershell.exe -STA -File Tools\Invoke-InterfaceDispatchHarness.ps1` per host; logs land in `Logs\DispatchHarness\` with queue-delay summaries printed to the console. | Attach the generated log paths and resulting queue-delay summary (`QueueDelaySummary-<timestamp>.json`) to Plan A + telemetry bundles (ST-A-005/006). |
| Shared cache warmup | `Tools\Invoke-SharedCacheWarmup.ps1 -ShowSharedCacheSummary -RequiredSites BOYO,WLLS` | Prepares snapshots before verification. | Attach `SharedCacheSnapshot-*-summary.json` stats. |
| Shared cache diagnostics | `Tools\Analyze-SharedCacheStoreState.ps1 -Path Logs\IngestionMetrics\<file>.json [-IncludeSiteBreakdown]` | Summarizes `InterfaceSiteCacheSharedStore*` telemetry (SnapshotImported hits, GetMiss/GetHit ratios, top sites). Run after any cold/warm harness to confirm snapshots were imported and to spot remaining Access hydrations. See `docs/CODEX_SHARED_CACHE_DIAGNOSTICS.md` for the full workflow. | Paste summary table (or note SnapshotImported=0) in plan/task update; link the analyzed log. |
| Provider reason diagnostics | `Tools\Analyze-SiteCacheProviderReasons.ps1 -Path Logs\IngestionMetrics\<file>.json [-IncludeHostBreakdown]` | Aggregates `InterfaceSyncTiming.SiteCacheProvider*` fields so you can see AccessRefresh vs. SharedCacheMatch per site; optional host breakdown surfaces worst offenders + fetch durations (details in `docs/CODEX_SHARED_CACHE_DIAGNOSTICS.md`). | Reference counts (per site) in plan/task updates; attach host table when AccessRefresh persists. |
| Reset online-mode flags | `Tools\Reset-OnlineModeFlags.ps1 -Reason "PlanF ST-F-009 wrap-up" [-EnvVarNames …] [-OutputDirectory Logs\NetOps]` | Clears `STATETRACE_AGENT_ALLOW_*`, writes `Logs/NetOps/Resets/OnlineModeReset-<timestamp>.json` (now with the supplied reason), and prints the evidence path so session/task updates can cite it. Run immediately after any online-mode work. | Mention the reset log path + reason in your session log, plan update, and Task Board entry. |
| Analyze diff hotspots | `Tools\Analyze-WarmRunDiffHotspots.ps1 -TelemetryPath Logs\IngestionMetrics\<warm run>.json -Top 20` | Useful for Plan B + C investigations. | Link exported table or paste top offenders. |
| Incremental loading verification | `Tools\Invoke-StateTracePipeline.ps1 -SkipTests -VerboseParsing -ResetExtractedLogs` (fairness guard on by default) then follow `docs/StateTrace_Operators_Runbook.md` (Interfaces view + telemetry capture). | Confirms streaming UI stays responsive and that `PortBatchReady`/`InterfaceSyncTiming` metrics hit the documented targets. The parser scheduler fairness guard fails the run whenever `ParserSchedulerLaunch` shows streaks above the configured limit—only disable it (`-FailOnSchedulerFairness:$false`) when replaying historical telemetry and note the exception. | Record `Logs/IngestionMetrics/<date>.json` path, PortBatchReady count, InterfaceSyncTiming durations, and UI observations in session log/plan update. |
| UI smoke test | Follow `docs/UI_Smoke_Checklist.md` (launch `Main/MainWindow.ps1`, exercise each tab, optional span harness). | Note any view regressions plus span snapshot output. | Checklist completion logged in session notes + plan/task entry. |
| SPAN view smoke test | `pwsh -STA -File Tools\Invoke-SpanViewSmokeTest.ps1 -Hostname <host> -PassThru` | Loads the SPAN view off-screen, triggers `Get-SpanInfo`, and emits a snapshot so regressions surface without the full UI. | Capture the returned object (row count, VLAN samples) and reference the log (`Logs/Debug/SpanDiag.log`) in your plan/session notes. |
| Freshness telemetry summary | `pwsh -NoLogo -File Tools\Analyze-FreshnessTelemetry.ps1 -Path Logs\IngestionMetrics\<date>.json -OutputPath Logs\Reports\FreshnessTelemetrySummary-<date>.json` | Summarizes cache provider/status signals per site for the freshness label (Plan H); handles newline JSON. | Reference the summary path in Plan H/task updates and include in UI bundles when showing freshness coverage. |
| Session wrap | `docs/CODEX_SESSION_CHECKLIST.md` + CLI summary | Use at the end of every run to ensure plan/backlog/task board/session log updates are complete. | CLI summary references plan/backlog IDs + telemetry artifacts. |

## Validation checklist
1. **Commands executed** – capture the exact command (with parameters) per task.
2. **Telemetry saved** – drop JSON/CSV outputs under `Logs/` (already ignored) and reference them in docs.
3. **Docs updated** – edit the relevant plan file, task board entry, and backlog row.
4. **Session logged** – add/update `docs/agents/sessions/<date>_session-XXXX.md`.

## Environment setup
- PowerShell 5.x (already available in the repo’s target environment).
- Optional online dev mode requires `STATETRACE_AGENT_ALLOW_NET=1` and `STATETRACE_AGENT_ALLOW_INSTALL=1`, plus logging via `Tools/NetworkGuard.psm1::Invoke-AllowedDownload`.

## Troubleshooting
- If `Invoke-StateTracePipeline.ps1` fails due to history corruption, clear `Data/IngestionHistory/*.json` (back them up first) and rerun.
- For Access contention, rerun with reduced concurrency overrides (`-ThreadCeilingOverride 1 -MaxWorkersPerSiteOverride 1 -MaxConsecutiveSiteLaunchesOverride 4`) and log the difference in Plan B.

Keep this runbook short and scriptable—extend the table rather than writing prose when you add new tasks.


